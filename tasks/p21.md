# Task: P.21 Three-Panel Camera Rig Visualization

## Objective

Modify `plot_camera_rig()` to produce a three-panel figure showing the camera rig from three viewing angles: the current default perspective, a top-down view, and a side-on view. Also update the inline initial rig plot in `pipeline.py` to use the same function.

## Context Files

Read these files before starting (in order):

1. `src/aquacal/validation/diagnostics.py` (lines 427-541) — `plot_camera_rig()` current implementation. Single 3D subplot with camera positions, optical axis arrows, water surface plane, inverted Z-axis.
2. `src/aquacal/validation/diagnostics.py` (lines 749-755) — Call site in `save_diagnostic_report()` that saves `camera_rig.png`.
3. `src/aquacal/calibration/pipeline.py` (lines 394-418) — Inline initial rig plot saved as `camera_rig_initial.png`. Currently a simple scatter plot (no optical axes, no water surface). Should be replaced with a call to `plot_camera_rig()`.

## Modify

- `src/aquacal/validation/diagnostics.py`
- `src/aquacal/calibration/pipeline.py`

## Do Not Modify

Everything not listed above. In particular:
- No test changes needed — this is a visual-only change with no behavioral impact on calibration

## Design

### Part 1: Refactor `plot_camera_rig()` to Three Panels

Change the function signature to remove the `ax` parameter (no longer accepts a single external axes) and produce a `1×3` subplot figure:

```python
def plot_camera_rig(
    calibration: CalibrationResult,
    arrow_length: float = 0.05,
    title: str = "Camera Rig Layout",
) -> "plt.Figure":
```

Key changes:

1. **Create a `1×3` figure** with three 3D subplots:
   ```python
   fig = plt.figure(figsize=(20, 7))
   axes = [fig.add_subplot(1, 3, i+1, projection="3d") for i in range(3)]
   ```

2. **Extract the plotting logic** into a helper that draws on a given axes (camera dots, labels, optical axis arrows, water surface plane, axis labels, inverted Z, equal aspect). Call it once per axes.

3. **Set viewing angles** via `ax.view_init(elev, azim)`:
   - Panel 1 (Perspective): `elev=30, azim=-60` — matplotlib's default, matches current behavior
   - Panel 2 (Top-down): `elev=90, azim=-90` — looking straight down the Z axis (plan view)
   - Panel 3 (Side): `elev=0, azim=0` — looking along the Y axis (side elevation)

4. **Add panel subtitles**:
   - Panel 1: "Perspective"
   - Panel 2: "Top-Down (XY)"
   - Panel 3: "Side (XZ)"

5. **Set the overall figure title** using `fig.suptitle(title, fontsize=16)` and `fig.tight_layout()`.

### Part 2: Replace Inline Pipeline Plot

Replace the inline scatter plot in `pipeline.py` (lines 394-418) with a call to `plot_camera_rig()`. This requires building a temporary `CalibrationResult`-like object or adjusting the function. Since at Stage 2 we only have extrinsics (no interface distances), the simplest approach:

```python
from aquacal.validation.diagnostics import plot_camera_rig
from aquacal.config.schema import CalibrationResult, CameraCalibration

# Build a temporary CalibrationResult for plotting
temp_cameras = {}
for cam_name, ext in extrinsics.items():
    temp_cameras[cam_name] = CameraCalibration(
        intrinsics=intrinsics[cam_name],
        extrinsics=ext,
        interface_distance=initial_distances.get(cam_name, 0.15),
    )
temp_result = CalibrationResult(cameras=temp_cameras, board_poses={})

fig = plot_camera_rig(
    temp_result,
    title="Stage 2: Initial Camera Positions (pre-optimization)",
)
fig.savefig(str(config.output_dir / "camera_rig_initial.png"), dpi=150, bbox_inches="tight")
plt.close(fig)
print("  Saved camera_rig_initial.png")
```

Check what `initial_distances` is called at that point in the pipeline — use the same variable. The goal is to show the water surface in the initial plot too.

## Acceptance Criteria

- [ ] `plot_camera_rig()` returns a figure with 3 side-by-side 3D panels
- [ ] Panel 1: perspective view (elev=30, azim=-60)
- [ ] Panel 2: top-down view (elev=90, azim=-90)
- [ ] Panel 3: side-on view (elev=0, azim=0)
- [ ] Each panel shows camera positions, labels, optical axis arrows, water surface plane
- [ ] `camera_rig_initial.png` in pipeline uses `plot_camera_rig()` instead of inline scatter
- [ ] No test failures: `pytest tests/unit/test_diagnostics.py tests/unit/test_pipeline.py -v`

## Notes

1. **Why three panels**: A single 3D perspective can hide structure. The top-down view reveals XY layout (camera arrangement), the side view reveals Z spread (coplanarity), and the perspective gives overall spatial intuition. Together they make it much easier to spot initialization problems like the Z scatter visible in the current plots.

2. **Figure size**: `(20, 7)` gives roughly square panels at reasonable resolution. The `dpi=150` in the pipeline save and `dpi=100` in the diagnostics save keep file sizes reasonable.

3. **`ax` parameter removal**: The old `ax` parameter let callers provide an external axes, but no code uses it that way (both call sites pass `ax=None`). Removing it simplifies the three-panel refactor. If external axes support is ever needed again, a separate `_plot_camera_rig_single()` helper can be exposed.

4. **`title` parameter**: Added so the pipeline can pass "Stage 2: Initial Camera Positions (pre-optimization)" while the diagnostics save uses the default "Camera Rig Layout".

## Model Recommendation

**Sonnet** — Straightforward matplotlib refactor. No algorithmic complexity, just subplot layout and view angles.
