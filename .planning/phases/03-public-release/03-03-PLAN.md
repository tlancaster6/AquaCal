---
phase: 03-public-release
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - .zenodo.json
autonomous: false
user_setup:
  - service: Zenodo
    why: "Automatic DOI minting for releases"
    dashboard_config:
      - task: "Enable Zenodo-GitHub webhook"
        location: "Zenodo.org -> Settings -> GitHub -> Enable repository tlancaster6/AquaCal"
  - service: PyPI
    why: "Trusted Publishing for package uploads"
    dashboard_config:
      - task: "Create pending Trusted Publisher"
        location: "PyPI -> Your projects -> Publishing -> Add pending publisher: owner=tlancaster6, repo=AquaCal, workflow=publish.yml, environment=pypi"
  - service: GitHub
    why: "PyPI environment for Trusted Publishing"
    dashboard_config:
      - task: "Create 'pypi' environment"
        location: "GitHub -> Settings -> Environments -> New environment -> name: pypi"

must_haves:
  truths:
    - "Package builds and installs from TestPyPI without errors"
    - "All tests pass before release"
    - ".zenodo.json provides metadata for Zenodo DOI archival"
    - "User has triggered v1.0.0 release via semantic-release or manual tag"
    - "Package is installable via pip install aquacal from PyPI"
  artifacts:
    - path: ".zenodo.json"
      provides: "Zenodo metadata for automatic DOI minting"
      contains: "\"title\": \"AquaCal\""
  key_links:
    - from: ".zenodo.json"
      to: "Zenodo webhook"
      via: "GitHub release triggers Zenodo archival"
      pattern: "\"upload_type\": \"software\""
    - from: ".github/workflows/publish.yml"
      to: "PyPI"
      via: "Tag push triggers Trusted Publishing upload"
      pattern: "pypa/gh-action-pypi-publish"
---

<objective>
Create Zenodo metadata, validate package on TestPyPI, and guide user through the v1.0.0 release process.

Purpose: Final validation before the public release. TestPyPI dry-run catches packaging issues. Zenodo metadata ensures proper DOI archival. The checkpoint guides the user through external service setup and release trigger.

Output: .zenodo.json, validated TestPyPI upload, user-triggered v1.0.0 release.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-public-release/03-CONTEXT.md
@.planning/phases/03-public-release/03-01-SUMMARY.md
@.planning/phases/03-public-release/03-02-SUMMARY.md
@pyproject.toml
@.github/workflows/publish.yml
@.github/workflows/release.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create .zenodo.json and run TestPyPI validation</name>
  <files>.zenodo.json</files>
  <action>
1. Create .zenodo.json at repo root with Zenodo deposit metadata:
   ```json
   {
     "title": "AquaCal: Refractive Multi-Camera Calibration",
     "description": "Calibration library for underwater multi-camera arrays viewing through a flat water surface, with Snell's law refraction modeling.",
     "upload_type": "software",
     "creators": [
       {
         "name": "Lancaster, Tucker",
         "affiliation": ""
       }
     ],
     "keywords": [
       "calibration",
       "multi-camera",
       "underwater",
       "refraction",
       "computer-vision",
       "snell-law",
       "bundle-adjustment"
     ],
     "license": {
       "id": "MIT"
     },
     "access_right": "open",
     "related_identifiers": [
       {
         "identifier": "https://github.com/tlancaster6/AquaCal",
         "relation": "isSupplementTo",
         "scheme": "url"
       }
     ]
   }
   ```

2. Run pre-release validation checklist (automated steps):
   a. Build the package: `python -m build`
   b. Check built distributions with twine: `pip install twine && twine check dist/*`
   c. Run full test suite: `python -m pytest tests/ -m "not slow"`
   d. Verify README renders: `pip install readme_renderer && python -m readme_renderer README.md > /dev/null` (catches PyPI rendering issues)
   e. Attempt TestPyPI upload if twine check passes: `twine upload --repository testpypi dist/*` (requires TestPyPI token — if auth fails, note this for the checkpoint)
   f. If TestPyPI upload succeeds, test install: `pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ aquacal`

Note: TestPyPI upload may fail if the user hasn't configured TestPyPI credentials. This is acceptable — twine check is the critical local validation. Document the result for the checkpoint.
  </action>
  <verify>
Verify .zenodo.json exists and contains "upload_type": "software".
Verify `python -m build` succeeds producing both .tar.gz and .whl in dist/.
Verify `twine check dist/*` reports PASSED for both distributions.
Verify `python -m pytest tests/ -m "not slow"` passes.
  </verify>
  <done>.zenodo.json created with valid Zenodo metadata. Package builds cleanly and passes twine check. Tests pass.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Pre-release validation and release trigger</name>
  <what-built>
All v1.0.0 release artifacts are prepared:
- Community files: CODE_OF_CONDUCT.md, updated LICENSE, CITATION.cff
- GitHub templates: issue templates, PR template
- README with badges, features, citation section
- CHANGELOG with [1.0.0] entry
- .zenodo.json for DOI archival
- Package validated (builds, twine check passed, tests pass)
  </what-built>
  <how-to-verify>
**Pre-release checklist — verify these before triggering release:**

1. **External service setup** (one-time, if not already done):
   - [ ] PyPI: Create pending Trusted Publisher (PyPI -> Publishing -> Add pending publisher: owner=tlancaster6, repo=AquaCal, workflow=publish.yml, environment=pypi)
   - [ ] GitHub: Create 'pypi' environment (Settings -> Environments -> New environment -> pypi)
   - [ ] Zenodo: Enable GitHub webhook (Zenodo.org -> Settings -> GitHub -> Enable tlancaster6/AquaCal)
   - [ ] Codecov: Enable repository and add CODECOV_TOKEN secret (if not done in Phase 2)

2. **Review files** (quick scan):
   - [ ] README.md renders well on GitHub (check after push)
   - [ ] CHANGELOG.md [1.0.0] entry looks correct
   - [ ] CITATION.cff metadata is accurate
   - [ ] Badges will resolve once PyPI package exists (DOI badge is placeholder until Zenodo mints)

3. **Trigger release** (choose one method):
   - **Option A (recommended)**: Push all changes to main. The release.yml workflow runs python-semantic-release which analyzes commits, bumps version, creates tag + GitHub Release. The tag triggers publish.yml which uploads to PyPI.
   - **Option B (manual)**: Create tag manually: `git tag v1.0.0 && git push origin v1.0.0`. This triggers publish.yml directly.

4. **Post-release verification:**
   - [ ] `pip install aquacal` works in a fresh virtualenv
   - [ ] `python -c "import aquacal; print(aquacal.__version__)"` shows 1.0.0
   - [ ] PyPI page (https://pypi.org/project/aquacal/) shows correct metadata
   - [ ] GitHub Release page has CHANGELOG excerpt
   - [ ] Zenodo DOI is minted (check https://zenodo.org/search?q=aquacal)
   - [ ] Update DOI badge in README.md with actual Zenodo DOI once available

**Note:** After Zenodo mints the DOI, update the DOI badge in README.md from the placeholder to the real Zenodo DOI badge URL. This is a post-release follow-up.
  </how-to-verify>
  <resume-signal>Type "released" after v1.0.0 is live on PyPI, or describe any issues encountered.</resume-signal>
</task>

</tasks>

<verification>
- .zenodo.json exists at repo root with valid metadata
- Package builds and passes twine check
- All tests pass
- User has completed external service setup
- v1.0.0 is published to PyPI (after user action)
</verification>

<success_criteria>
Package is published to PyPI as v1.0.0. Users can `pip install aquacal`. Zenodo DOI is minted. GitHub Release exists with changelog.
</success_criteria>

<output>
After completion, create `.planning/phases/03-public-release/03-03-SUMMARY.md`
</output>
