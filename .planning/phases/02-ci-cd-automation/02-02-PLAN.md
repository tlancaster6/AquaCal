---
phase: 02-ci-cd-automation
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - .github/workflows/test.yml
  - .github/workflows/slow-tests.yml
autonomous: true

must_haves:
  truths:
    - "Fast tests run on push to main and PR to main across 6-job matrix (3 Python x 2 OS)"
    - "Slow tests run only via manual trigger (workflow_dispatch)"
    - "Pre-commit hooks are enforced in CI as a separate job"
    - "Coverage XML is generated and uploaded to Codecov"
  artifacts:
    - path: ".github/workflows/test.yml"
      provides: "Fast test workflow with matrix strategy and pre-commit CI job"
      contains: "pytest tests/ -m"
    - path: ".github/workflows/slow-tests.yml"
      provides: "Manual-trigger slow test workflow"
      contains: "workflow_dispatch"
  key_links:
    - from: ".github/workflows/test.yml"
      to: "pyproject.toml"
      via: "pip install -e .[dev] reads dev deps"
      pattern: "pip install.*dev"
    - from: ".github/workflows/test.yml"
      to: ".pre-commit-config.yaml"
      via: "pre-commit run --all-files reads hook config"
      pattern: "pre-commit run"
---

<objective>
Create GitHub Actions test workflows: test.yml for fast tests with 6-job matrix and pre-commit enforcement, slow-tests.yml for manual-trigger full test suite.

Purpose: Automated testing on every push/PR catches regressions across Python 3.10-3.12 on Linux and Windows. Slow optimization tests kept separate to maintain fast PR feedback.
Output: Two workflow files in .github/workflows/
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ci-cd-automation/02-RESEARCH.md
@.planning/phases/02-ci-cd-automation/02-01-SUMMARY.md
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test.yml with matrix strategy and pre-commit CI job</name>
  <files>.github/workflows/test.yml</files>
  <action>
Create `.github/workflows/test.yml` with two jobs: `test` and `pre-commit`.

**test job:**
- runs-on: `${{ matrix.os }}`
- strategy: fail-fast: false, matrix: os [ubuntu-latest, windows-latest], python-version ["3.10", "3.11", "3.12"]
- MUST quote Python versions ("3.10" not 3.10 -- YAML parses unquoted as float 3.1)
- Steps:
  1. actions/checkout@v4
  2. actions/setup-python@v5 with python-version and cache: 'pip' and cache-dependency-path: 'pyproject.toml'
  3. Install: `python -m pip install --upgrade pip` then `pip install -e ".[dev]"`
  4. Run tests: `pytest tests/ -m "not slow" --cov=aquacal --cov-report=xml --cov-report=term`
  5. Upload coverage: codecov/codecov-action@v5 with token: `${{ secrets.CODECOV_TOKEN }}`, fail_ci_if_error: false (graceful if Codecov not configured yet)

**pre-commit job:**
- runs-on: ubuntu-latest
- Steps:
  1. actions/checkout@v4
  2. actions/setup-python@v5 with python-version: '3.12'
  3. Install pre-commit: `pip install pre-commit`
  4. Run: `pre-commit run --all-files`

Triggers: push to main, pull_request to main.

Per user decision: pre-commit enforced in CI to catch contributors who skip local hooks.
  </action>
  <verify>Validate YAML syntax: `python -c "import yaml; yaml.safe_load(open('.github/workflows/test.yml'))"`. Confirm matrix has 6 combinations (2 OS x 3 Python). Confirm fail-fast is false. Confirm pytest command includes `-m 'not slow'` and `--cov` flags. Confirm pre-commit job exists as separate job.</verify>
  <done>test.yml triggers on push/PR to main, runs fast tests across 6-job matrix with coverage upload, and enforces pre-commit in a parallel CI job</done>
</task>

<task type="auto">
  <name>Task 2: Create slow-tests.yml with manual trigger</name>
  <files>.github/workflows/slow-tests.yml</files>
  <action>
Create `.github/workflows/slow-tests.yml` with:

- Trigger: workflow_dispatch only (manual trigger, no push/PR)
- Inputs: python-version (choice: "3.10", "3.11", "3.12", default "3.12") and os (choice: "ubuntu-latest", "windows-latest", default "ubuntu-latest")
- Job: slow-tests
  - runs-on: `${{ inputs.os || 'ubuntu-latest' }}`
  - timeout-minutes: 60 (prevent runaway optimization tests)
  - Steps:
    1. actions/checkout@v4
    2. actions/setup-python@v5 with python-version: `${{ inputs.python-version || '3.12' }}`, cache: 'pip', cache-dependency-path: 'pyproject.toml'
    3. Install: `python -m pip install --upgrade pip` then `pip install -e ".[dev]"`
    4. Run full test suite: `pytest tests/ --cov=aquacal --cov-report=xml --cov-report=term` (NO `-m "not slow"` -- runs ALL tests including slow)
    5. Upload coverage: codecov/codecov-action@v5 with token: `${{ secrets.CODECOV_TOKEN }}`

Per user decision: slow tests (optimization-based, synthetic pipeline) in separate workflow with manual trigger only.
  </action>
  <verify>Validate YAML syntax: `python -c "import yaml; yaml.safe_load(open('.github/workflows/slow-tests.yml'))"`. Confirm trigger is workflow_dispatch only (no push/pull_request). Confirm timeout-minutes is set. Confirm pytest command does NOT include `-m "not slow"` (runs all tests).</verify>
  <done>slow-tests.yml exists with manual trigger, configurable Python version and OS inputs, 60-minute timeout, and full test suite execution</done>
</task>

</tasks>

<verification>
- .github/workflows/test.yml exists with valid YAML
- test.yml has 6-job matrix (2 OS x 3 Python), fail-fast: false
- test.yml has separate pre-commit job
- .github/workflows/slow-tests.yml exists with valid YAML
- slow-tests.yml has workflow_dispatch trigger only
- Both workflows install via pip install -e ".[dev]"
</verification>

<success_criteria>
- test.yml runs fast tests across Python 3.10/3.11/3.12 on Linux/Windows with coverage
- test.yml enforces pre-commit in parallel CI job
- slow-tests.yml runs full test suite on manual trigger with configurable inputs
- All Python versions quoted as strings in YAML
</success_criteria>

<output>
After completion, create `.planning/phases/02-ci-cd-automation/02-02-SUMMARY.md`
</output>
