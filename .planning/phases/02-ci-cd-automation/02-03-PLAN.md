---
phase: 02-ci-cd-automation
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - .github/workflows/docs.yml
  - .github/workflows/publish.yml
  - docs/conf.py
  - docs/index.rst
  - docs/Makefile
  - docs/make.bat
autonomous: true
user_setup:
  - service: pypi
    why: "Trusted Publishing requires OIDC configuration on PyPI before first publish"
    env_vars: []
    dashboard_config:
      - task: "Create pending Trusted Publisher on PyPI"
        location: "PyPI -> Your projects -> aquacal -> Publishing -> Add a new pending publisher (or manage existing). Set: repository owner=tlancaster6, repository name=AquaCal, workflow name=publish.yml, environment name=pypi"
  - service: github
    why: "GitHub environment 'pypi' needed for publish workflow protection"
    env_vars: []
    dashboard_config:
      - task: "Create 'pypi' environment in GitHub repo settings"
        location: "GitHub -> Settings -> Environments -> New environment -> name: pypi"
  - service: codecov
    why: "Coverage reporting on PRs"
    env_vars:
      - name: CODECOV_TOKEN
        source: "Codecov.io -> Settings -> General -> Upload Token (add as GitHub repo secret)"
    dashboard_config:
      - task: "Enable repository on Codecov"
        location: "Codecov.io -> Add new repository -> select AquaCal"

must_haves:
  truths:
    - "Sphinx documentation builds in CI on PRs to catch doc errors before merge"
    - "PyPI publish triggers on git tag push with test gate before publishing"
    - "Trusted Publishing uses OIDC (no API tokens) with id-token: write only on publish job"
    - "Minimal Sphinx docs setup exists so docs.yml has something to build"
  artifacts:
    - path: ".github/workflows/docs.yml"
      provides: "Sphinx doc build validation on PR"
      contains: "sphinx"
    - path: ".github/workflows/publish.yml"
      provides: "PyPI Trusted Publishing workflow with test gate"
      contains: "pypa/gh-action-pypi-publish"
    - path: "docs/conf.py"
      provides: "Minimal Sphinx configuration"
      contains: "aquacal"
    - path: "docs/index.rst"
      provides: "Documentation root page"
      contains: "toctree"
  key_links:
    - from: ".github/workflows/publish.yml"
      to: "pyproject.toml"
      via: "python -m build reads package metadata"
      pattern: "python -m build"
    - from: ".github/workflows/docs.yml"
      to: "docs/conf.py"
      via: "sphinx-build reads conf.py"
      pattern: "sphinx-build\\|make html"
---

<objective>
Create docs.yml workflow for Sphinx doc build validation, publish.yml for PyPI Trusted Publishing, and minimal Sphinx docs scaffolding.

Purpose: docs.yml catches documentation build errors before merge. publish.yml enables automated PyPI releases on git tag with test safety gate. Minimal docs/ setup gives docs.yml something to build (full documentation content comes in Phase 5).
Output: Two workflow files and minimal docs/ directory
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ci-cd-automation/02-RESEARCH.md
@.planning/phases/02-ci-cd-automation/02-01-SUMMARY.md
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create docs.yml workflow and minimal Sphinx scaffolding</name>
  <files>
    .github/workflows/docs.yml
    docs/conf.py
    docs/index.rst
    docs/Makefile
    docs/make.bat
  </files>
  <action>
**1. Create minimal Sphinx scaffolding in `docs/`:**

`docs/conf.py`:
```python
project = "AquaCal"
copyright = "2024, Tucker Lancaster"
author = "Tucker Lancaster"
extensions = ["sphinx.ext.autodoc", "sphinx.ext.napoleon"]
templates_path = ["_templates"]
exclude_patterns = ["_build"]
html_theme = "sphinx_rtd_theme"
```

`docs/index.rst`:
```rst
AquaCal Documentation
=====================

.. toctree::
   :maxdepth: 2
   :caption: Contents:

Indices and tables
==================

* :ref:`genindex`
* :ref:`modindex`
```

`docs/Makefile` (standard Sphinx Makefile with SPHINXBUILD, SOURCEDIR, BUILDDIR).

`docs/make.bat` (standard Sphinx make.bat for Windows).

This is a MINIMAL scaffold -- Phase 5 will add real content. The purpose here is to give docs.yml something to successfully build.

**2. Create `.github/workflows/docs.yml`:**

- Trigger: pull_request to main only (no push trigger)
- Job: build-docs on ubuntu-latest
- Steps:
  1. actions/checkout@v4
  2. actions/setup-python@v5 with python-version: '3.12', cache: 'pip', cache-dependency-path: 'pyproject.toml'
  3. Install: `python -m pip install --upgrade pip` then `pip install -e ".[dev]"` then `pip install sphinx sphinx-rtd-theme`
  4. Build docs: `sphinx-build -W --keep-going -b html docs docs/_build/html`
     - `-W` treats warnings as errors (catches broken refs)
     - `--keep-going` shows ALL warnings before failing (not just first)
     - Using `sphinx-build` directly instead of `make html` for consistency across platforms

Do NOT add sphinx/sphinx-rtd-theme to pyproject.toml dev deps yet -- that's a Phase 5 concern. The CI workflow installs them explicitly.
  </action>
  <verify>Validate YAML: `python -c "import yaml; yaml.safe_load(open('.github/workflows/docs.yml'))"`. Confirm docs/conf.py exists and imports correctly: `python -c "exec(open('docs/conf.py').read()); print(project)"`. Confirm docs/index.rst exists. Confirm docs.yml trigger is pull_request only (no push).</verify>
  <done>docs.yml validates Sphinx build on PRs with -W flag. Minimal docs/ scaffolding (conf.py, index.rst, Makefile, make.bat) exists for CI to build against.</done>
</task>

<task type="auto">
  <name>Task 2: Create publish.yml with Trusted Publishing and test gate</name>
  <files>.github/workflows/publish.yml</files>
  <action>
Create `.github/workflows/publish.yml` with three jobs: test, build, publish.

- Trigger: push tags matching `v*` (e.g., v1.0.0)

**test job:**
- runs-on: ubuntu-latest
- Steps:
  1. actions/checkout@v4
  2. actions/setup-python@v5 with python-version: '3.12', cache: 'pip', cache-dependency-path: 'pyproject.toml'
  3. Install: `python -m pip install --upgrade pip` then `pip install -e ".[dev]"`
  4. Run fast tests: `pytest tests/ -m "not slow"`

**build job:**
- needs: test (tests must pass before building)
- runs-on: ubuntu-latest
- Steps:
  1. actions/checkout@v4
  2. actions/setup-python@v5 with python-version: '3.12'
  3. Install build tool: `python -m pip install --upgrade pip build`
  4. Build: `python -m build`
  5. Upload artifact: actions/upload-artifact@v4 with name: dist, path: dist/

**publish job:**
- needs: build (build must succeed before publishing)
- runs-on: ubuntu-latest
- environment: pypi (matches PyPI Trusted Publisher config)
- permissions: id-token: write (ONLY on this job -- principle of least privilege)
- Steps:
  1. actions/download-artifact@v4 with name: dist, path: dist/
  2. pypa/gh-action-pypi-publish@release/v1 (NO username/password/token -- OIDC handles auth)

CRITICAL: id-token: write permission ONLY on publish job, NOT at workflow level. Do NOT add any secrets for PyPI auth.

Per user decision: tests must pass before publish, even though main should be green.
  </action>
  <verify>Validate YAML: `python -c "import yaml; d=yaml.safe_load(open('.github/workflows/publish.yml')); jobs=list(d['jobs'].keys()); print(jobs); print(d['jobs']['publish'].get('permissions',{})); print(d['jobs']['publish'].get('environment',''))"`. Confirm three jobs (test, build, publish). Confirm publish has id-token: write and environment: pypi. Confirm build needs test, publish needs build. Confirm NO secrets/tokens for PyPI.</verify>
  <done>publish.yml triggers on v* tags, runs tests first, builds package, then publishes to PyPI via Trusted Publishing (OIDC) with id-token: write scoped only to publish job</done>
</task>

</tasks>

<verification>
- .github/workflows/docs.yml exists with valid YAML, triggers on PR only
- .github/workflows/publish.yml exists with valid YAML, triggers on v* tags
- publish.yml has 3 jobs with correct dependency chain (test -> build -> publish)
- publish.yml id-token: write is job-level only (not workflow-level)
- docs/ directory has conf.py, index.rst, Makefile, make.bat
- Sphinx build would succeed locally: `sphinx-build -b html docs docs/_build/html`
</verification>

<success_criteria>
- docs.yml catches Sphinx build errors on PRs with -W flag
- publish.yml publishes to PyPI on tag via Trusted Publishing with test gate
- Minimal docs scaffolding exists for CI validation
- No API tokens or secrets used for PyPI authentication
</success_criteria>

<output>
After completion, create `.planning/phases/02-ci-cd-automation/02-03-SUMMARY.md`
</output>
