---
phase: 14-geometry-rewiring
plan: 03
type: execute
wave: 3
depends_on: ["14-02"]
files_modified:
  - src/aquacal/triangulation/triangulate.py
  - src/aquacal/core/__init__.py
autonomous: true

must_haves:
  truths:
    - "refractive_back_project call site in triangulate.py routes through bridge using _make_interface_params() factory"
    - "core/__init__.py exports bridge functions instead of originals for the 5 geometry names"
    - "No public call site in AquaCal imports directly from refractive_geometry for the 5 deprecated functions"
    - "AquaKit's InterfaceParams type is NOT added to core/__init__.py public API — AquaCal's own InterfaceParams (from aquacal.config.schema) remains the only InterfaceParams visible in aquacal.core"
  artifacts:
    - path: "src/aquacal/triangulation/triangulate.py"
      provides: "Triangulation using bridge back-projection"
      contains: "_bridge_refractive_back_project"
    - path: "src/aquacal/core/__init__.py"
      provides: "Public API re-exporting bridge functions without exposing AquaKit types"
      contains: "_bridge_refractive_project"
  key_links:
    - from: "src/aquacal/triangulation/triangulate.py"
      to: "src/aquacal/core/_aquakit_bridge.py"
      via: "from aquacal.core._aquakit_bridge import _bridge_refractive_back_project, _make_interface_params"
      pattern: "_bridge_refractive_back_project"
    - from: "src/aquacal/core/__init__.py"
      to: "src/aquacal/core/_aquakit_bridge.py"
      via: "from aquacal.core._aquakit_bridge import ... (no InterfaceParams)"
      pattern: "_bridge_refractive_project"
---

<objective>
Rewire the `refractive_back_project` call site in `triangulate.py` through the bridge, and update `core/__init__.py` so its public API exports the bridge wrapper names (keeping the old names available for backward compatibility if needed but pointing to bridge implementations).

Purpose: Completes the geometry rewiring — all 5 functions now route through AquaKit at every internal call site.

Output: `triangulate.py` and `core/__init__.py` updated.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/14-geometry-rewiring/14-CONTEXT.md
@.planning/phases/14-geometry-rewiring/14-02-SUMMARY.md
@src/aquacal/core/_aquakit_bridge.py
@src/aquacal/triangulation/triangulate.py
@src/aquacal/core/__init__.py
@src/aquacal/core/interface_model.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewire refractive_back_project in triangulate.py</name>
  <files>src/aquacal/triangulation/triangulate.py</files>
  <action>
Read `src/aquacal/triangulation/triangulate.py`. The file uses `refractive_back_project(camera, interface, pixel)` which returns `(ray_origin, ray_direction) | (None, None)`.

The bridge function `_bridge_refractive_back_project(camera, interface_aq, pixel)` has the same return shape.

Steps:
1. **Remove** import: `from aquacal.core.refractive_geometry import refractive_back_project`
2. **Add** import: `from aquacal.core._aquakit_bridge import _bridge_refractive_back_project, _make_interface_params`
   (Do NOT import `InterfaceParams` by name — use the factory to avoid name collision with AquaCal's own `InterfaceParams`.)
3. **Do NOT add `import torch`** — `_make_interface_params()` handles torch internally.
4. **Update** the `triangulate_point` function: where it constructs an `Interface` object and passes it to `refractive_back_project`, instead call `_make_interface_params()` and pass the result to `_bridge_refractive_back_project`.

Current pattern in `triangulate_point`:
```python
interface = Interface(
    normal=calibration.interface.normal,
    camera_distances=camera_distances,
    n_air=calibration.interface.n_air,
    n_water=calibration.interface.n_water,
)
...
result = refractive_back_project(camera, interface, pixel)
```

Replace with:
```python
# For each camera, get its water_z from calibration
water_z_for_cam = calibration.cameras[cam_name].water_z
interface_aq = _make_interface_params(
    water_z=water_z_for_cam,
    n_air=calibration.interface.n_air,
    n_water=calibration.interface.n_water,
)
result = _bridge_refractive_back_project(camera, interface_aq, pixel)
```

Note: The `Interface` object is constructed once with `camera_distances` for all cameras, but `_bridge_refractive_back_project` needs a single `water_z` scalar. Extract it per-camera inside the loop using `calibration.cameras[cam_name].water_z`.

Also check if `Interface` is still imported/used anywhere else in the file after the change — if `Interface` import is no longer needed, remove it. Same for `camera_distances` dict construction if it was only used to build the Interface.

The return value of `_bridge_refractive_back_project` is `(Vec3, Vec3) | (None, None)` — same as before. No changes needed to the result handling (`if result[0] is not None: rays.append(...)`).
  </action>
  <verify>
Run: `python -m ruff check src/aquacal/triangulation/triangulate.py`

Run: `python -c "from aquacal.triangulation.triangulate import triangulate_point; print('ok')" 2>&1`
Expected: "ok" (import works).

Run: `python -m pytest tests/unit/test_triangulate.py -x --no-header -q 2>&1 | head -20`
(May fail if torch not installed locally — acceptable. Check for syntax/import errors vs torch missing.)
  </verify>
  <done>
`triangulate.py` uses `_bridge_refractive_back_project` instead of `refractive_back_project`. `_make_interface_params(water_z, n_air, n_water)` used per-camera instead of naming `InterfaceParams` directly. No `import torch` added to the file. Ruff clean. No import of `refractive_back_project` from refractive_geometry remains.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update core/__init__.py to export bridge functions</name>
  <files>src/aquacal/core/__init__.py</files>
  <action>
Read `src/aquacal/core/__init__.py`. Currently it exports:
- `ray_plane_intersection` from `interface_model`
- `snells_law_3d`, `trace_ray_air_to_water`, `refractive_project`, `refractive_project_batch`, `refractive_back_project` from `refractive_geometry`

Update it to:
1. **Remove** the import of `refractive_project_batch` from `refractive_geometry` (it no longer has a bridge equivalent — batch projection via bridge is done by looping `_bridge_refractive_project`, which is for Phase 16/17 to decide; for now just remove the batch shim from the public API since the fast shims were deleted in Plan 02).
2. **Add** imports from the bridge for the 5 geometry names. Keep the same public names as aliases so external users who imported from `aquacal.core` still work:
   ```python
   from aquacal.core._aquakit_bridge import (
       _bridge_ray_plane_intersection as ray_plane_intersection,
       _bridge_refractive_back_project as refractive_back_project,
       _bridge_refractive_project as refractive_project,
       _bridge_snells_law_3d as snells_law_3d,
       _bridge_trace_ray_air_to_water as trace_ray_air_to_water,
   )
   ```
   **Do NOT re-export `InterfaceParams` or `_make_interface_params` here.** These are bridge internals. The name `InterfaceParams` in AquaCal's public API still refers to AquaCal's own `InterfaceParams` from `aquacal.config.schema` — adding the AquaKit one would create a silent type collision for any external code that also imports from `aquacal.config.schema`.
3. **Remove** the old imports from `refractive_geometry` for these 5 functions (they're now coming from bridge).
4. **Remove** the old import of `ray_plane_intersection` from `interface_model` (now comes from bridge).
5. **Update `__all__`**: keep the same public names (`ray_plane_intersection`, `snells_law_3d`, etc.) since they're just aliases now. Remove `refractive_project_batch` from `__all__` since the batch shim was deleted. Do NOT add `InterfaceParams` (AquaKit type) to `__all__`.
6. **Keep** the imports of `Interface`, `BoardGeometry`, `Camera`, `undistort_points` unchanged.

The goal: external code that does `from aquacal.core import refractive_project` continues to work — it gets the bridge version.
  </action>
  <verify>
Run: `python -m ruff check src/aquacal/core/__init__.py`

Run: `python -c "from aquacal.core import refractive_project, refractive_back_project, snells_law_3d, trace_ray_air_to_water, ray_plane_intersection; print('ok')" 2>&1`
Expected: "ok" (all 5 geometry names importable from aquacal.core).

Run: `python -c "from aquacal.core import refractive_project_batch" 2>&1`
Expected: ImportError (batch removed from public API).

Run: `python -c "from aquacal.core import InterfaceParams; from aquacal.config.schema import InterfaceParams as SchemaIP; print(InterfaceParams is SchemaIP)" 2>&1`
Expected: "True" — the `InterfaceParams` in aquacal.core still refers to AquaCal's own schema type, not AquaKit's type. (If this fails with ImportError or prints "False", the AquaKit type has leaked into the public API — fix it.)
  </verify>
  <done>
`core/__init__.py` exports bridge-backed versions of all 5 geometry functions under their original public names. `InterfaceParams` (AquaKit type) is NOT added to the public API. `refractive_project_batch` removed. Ruff clean.
  </done>
</task>

</tasks>

<verification>
- `grep -rn "from aquacal.core.refractive_geometry import refractive_back_project" src/` returns no results
- `python -c "from aquacal.core import refractive_project, refractive_back_project, snells_law_3d; print('ok')"` prints "ok"
- `python -c "from aquacal.core import InterfaceParams; from aquacal.config.schema import InterfaceParams as S; print(InterfaceParams is S)"` prints "True" (AquaKit type did NOT leak into public API)
- `grep -n "_bridge_refractive_back_project" src/aquacal/triangulation/triangulate.py` shows at least 1 match
- `grep -n "_make_interface_params" src/aquacal/triangulation/triangulate.py` shows at least 1 match
- `python -m ruff check src/aquacal/core/ src/aquacal/triangulation/` passes
- `grep -n "refractive_project_batch" src/aquacal/core/__init__.py` returns no results
</verification>

<success_criteria>
`triangulate.py` routes through bridge using `_make_interface_params()` factory. `core/__init__.py` re-exports bridge functions under original public names without leaking AquaKit's `InterfaceParams` into the public API. All 5 geometry functions rewired. Phase 14 geometry rewiring complete.
</success_criteria>

<output>
After completion, create `.planning/phases/14-geometry-rewiring/14-03-SUMMARY.md`
</output>
