---
phase: 14-geometry-rewiring
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/aquacal/calibration/_optim_common.py
  - src/aquacal/calibration/extrinsics.py
  - src/aquacal/calibration/interface_estimation.py
  - src/aquacal/calibration/pipeline.py
  - src/aquacal/datasets/rendering.py
  - src/aquacal/datasets/synthetic.py
  - src/aquacal/validation/reprojection.py
  - src/aquacal/core/refractive_geometry.py
  - src/aquacal/core/interface_model.py
autonomous: true

must_haves:
  truths:
    - "All refractive_project call sites now call _bridge_refractive_project from the bridge instead of the original"
    - "refractive_project_fast and refractive_project_fast_batch are deleted from refractive_geometry.py"
    - "Original geometry implementations in refractive_geometry.py are marked with # DEPRECATED comment"
    - "No call site imports refractive_project from aquakit directly"
  artifacts:
    - path: "src/aquacal/calibration/_optim_common.py"
      provides: "Cost function using bridge projection"
      contains: "_bridge_refractive_project"
    - path: "src/aquacal/core/refractive_geometry.py"
      provides: "Original implementations with DEPRECATED markers, fast shims removed"
      contains: "# DEPRECATED"
  key_links:
    - from: "src/aquacal/calibration/_optim_common.py"
      to: "src/aquacal/core/_aquakit_bridge.py"
      via: "from aquacal.core._aquakit_bridge import _bridge_refractive_project, _make_interface_params"
      pattern: "_bridge_refractive_project"
    - from: "src/aquacal/validation/reprojection.py"
      to: "src/aquacal/core/_aquakit_bridge.py"
      via: "from aquacal.core._aquakit_bridge import _bridge_refractive_project, _make_interface_params"
      pattern: "_bridge_refractive_project"
---

<objective>
Rewire all `refractive_project` call sites to go through the bridge, and update `refractive_geometry.py` to remove the fast shims and mark original implementations as deprecated.

Purpose: After this plan, the forward projection path (the most-used geometry operation in calibration) routes through AquaKit. Original implementations remain for Phase 16 equivalence testing.

Output: 7 call-site files updated + `refractive_geometry.py` cleaned up.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/14-geometry-rewiring/14-CONTEXT.md
@.planning/phases/14-geometry-rewiring/14-01-SUMMARY.md
@src/aquacal/core/_aquakit_bridge.py
@src/aquacal/core/refractive_geometry.py
@src/aquacal/core/interface_model.py
@src/aquacal/calibration/_optim_common.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewire refractive_project call sites to bridge</name>
  <files>
    src/aquacal/calibration/_optim_common.py
    src/aquacal/calibration/extrinsics.py
    src/aquacal/calibration/interface_estimation.py
    src/aquacal/calibration/pipeline.py
    src/aquacal/datasets/rendering.py
    src/aquacal/datasets/synthetic.py
    src/aquacal/validation/reprojection.py
  </files>
  <action>
In each file, replace the import and call of `refractive_project` with `_bridge_refractive_project` from the bridge. The bridge function has the same signature as the original: `(camera: Camera, interface_aq, point_3d: Vec3) -> Vec2 | None`, where `interface_aq` is the result of `_make_interface_params()`.

**IMPORTANT: Interface type change.** The bridge accepts an AquaKit `InterfaceParams` object, not AquaCal's `Interface` type. Call sites must never import or name `InterfaceParams` directly — instead use the `_make_interface_params(water_z, n_air, n_water)` factory from the bridge. This avoids the name collision with AquaCal's own `InterfaceParams` in `aquacal.config.schema`.

For each call site:

1. **Remove** the old import: `from aquacal.core.refractive_geometry import refractive_project`
2. **Add** the new import: `from aquacal.core._aquakit_bridge import _bridge_refractive_project, _make_interface_params`
   (If `Interface` is still used elsewhere in the file for other purposes, keep its import. Do NOT add `import torch` — the factory handles torch internally.)
3. **Update the Interface construction** at each projection call site. Where code does:
   ```python
   interface = Interface(normal=..., camera_distances={cam_name: water_z}, n_air=..., n_water=...)
   projected = refractive_project(camera, interface, point_3d)
   ```
   Replace with:
   ```python
   interface_aq = _make_interface_params(water_z=water_z, n_air=n_air, n_water=n_water)
   projected = _bridge_refractive_project(camera, interface_aq, point_3d)
   ```
   The `water_z` scalar comes from whatever the file was using: `interface.get_water_z(cam_name)`, `water_zs[cam_name]`, `calibration.cameras[cam_name].water_z`, etc.

4. **Check each file carefully** to extract the right water_z and n_air/n_water values. Common patterns:
   - `_optim_common.py`: uses `water_zs[cam_name]`, `n_air`, `n_water` from unpacked params
   - `extrinsics.py`: read the file to find Interface construction; extract water_z accordingly
   - `interface_estimation.py`: lazy import inside function — update the lazy import
   - `pipeline.py`: lazy import inside function — update the lazy import
   - `rendering.py`: uses `interface.get_water_z(camera.name)`, `interface.n_air`, `interface.n_water`
   - `synthetic.py`: similar to rendering.py
   - `reprojection.py`: uses `calibration.cameras[cam_name].water_z`, `calibration.interface.n_air/n_water`

5. **Do NOT remove `Interface` imports** in files where `Interface` is still used for other things (e.g., constructing Camera objects, interface model testing). Only remove if the file no longer uses `Interface` at all after the rewiring.

6. **Do NOT add `import torch`** at call sites — `_make_interface_params()` handles the `torch.tensor` construction internally inside the bridge. This is the key benefit of the factory approach.

The `_bridge_refractive_project` call return value is `Vec2 | None` — same as before. No changes to callers' handling of the return value.
  </action>
  <verify>
Run: `python -m ruff check src/aquacal/calibration/ src/aquacal/datasets/ src/aquacal/validation/`

Expected: no errors in the modified files.

Also run: `python -m pytest tests/unit/test_reprojection.py tests/unit/test_optim_common.py -x --no-header -q 2>&1 | head -30`
(These may fail if torch is not installed locally — that is acceptable. The goal is no import errors or syntax errors.)
  </verify>
  <done>
All 7 files updated. Each uses `_bridge_refractive_project` instead of `refractive_project`. `_make_interface_params(water_z, n_air, n_water)` used at each call site instead of constructing an `Interface` or importing `InterfaceParams` by name. No `import torch` added to call sites. No import of `refractive_project` from `refractive_geometry` in any of these 7 files. Ruff clean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove fast shims and mark originals deprecated in refractive_geometry.py</name>
  <files>src/aquacal/core/refractive_geometry.py</files>
  <action>
Edit `src/aquacal/core/refractive_geometry.py`:

1. **Delete** the `refractive_project_fast` function entirely (lines defining the function and its body).

2. **Delete** the `refractive_project_fast_batch` function entirely (lines defining the function and its body).

3. **Delete** the comment `# Deprecated backward-compatibility shims` above those functions (if it still exists after deletion).

4. **Add `# DEPRECATED` comment** to the docstring or just above the `def` line of each original implementation that the bridge now supersedes. Mark these 5 functions:
   - `snells_law_3d` → add `# DEPRECATED: use _bridge_snells_law_3d from core._aquakit_bridge` above its `def`
   - `trace_ray_air_to_water` → add `# DEPRECATED: use _bridge_trace_ray_air_to_water from core._aquakit_bridge`
   - `refractive_back_project` → add `# DEPRECATED: use _bridge_refractive_back_project from core._aquakit_bridge`
   - `refractive_project` → add `# DEPRECATED: use _bridge_refractive_project from core._aquakit_bridge`
   - `refractive_project_batch` → add `# DEPRECATED: use _bridge_refractive_project (handles batch via loop) from core._aquakit_bridge`
   - Also add DEPRECATED comment to `ray_plane_intersection` in `interface_model.py`: `# DEPRECATED: use _bridge_ray_plane_intersection from core._aquakit_bridge`

5. **Also update** `src/aquacal/core/interface_model.py`: add `# DEPRECATED: use _bridge_ray_plane_intersection from core._aquakit_bridge` above the `def ray_plane_intersection` line.

Do NOT remove the actual implementations — they remain for Phase 16 equivalence testing and are deleted in Phase 17.
  </action>
  <verify>
Run: `python -m ruff check src/aquacal/core/refractive_geometry.py src/aquacal/core/interface_model.py`

Run: `python -c "from aquacal.core.refractive_geometry import refractive_project_fast" 2>&1`
Expected: ImportError (function deleted).

Run: `python -c "from aquacal.core.refractive_geometry import refractive_project; print('ok')" 2>&1`
Expected: "ok" (original still exists, just marked DEPRECATED).
  </verify>
  <done>
`refractive_project_fast` and `refractive_project_fast_batch` are deleted from `refractive_geometry.py`. All 5 original geometry functions in `refractive_geometry.py` and `ray_plane_intersection` in `interface_model.py` have `# DEPRECATED` comments. Ruff clean.
  </done>
</task>

</tasks>

<verification>
- `grep -n "refractive_project_fast" src/aquacal/core/refractive_geometry.py` returns no results
- `grep -rn "from aquacal.core.refractive_geometry import refractive_project" src/aquacal/calibration/ src/aquacal/datasets/ src/aquacal/validation/` returns no results
- `grep -rn "_bridge_refractive_project" src/` shows 7 call-site files + bridge module
- `grep -n "DEPRECATED" src/aquacal/core/refractive_geometry.py` shows 5 matches
- `grep -n "DEPRECATED" src/aquacal/core/interface_model.py` shows 1 match
- `python -m ruff check src/` passes
</verification>

<success_criteria>
All refractive_project call sites routed through bridge. Fast shims deleted. Original implementations marked DEPRECATED but not removed. Ruff clean across modified files.
</success_criteria>

<output>
After completion, create `.planning/phases/14-geometry-rewiring/14-02-SUMMARY.md`
</output>
