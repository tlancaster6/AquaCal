---
phase: 04-example-data
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aquacal/datasets/__init__.py
  - src/aquacal/datasets/synthetic.py
  - src/aquacal/datasets/rendering.py
  - tests/synthetic/ground_truth.py
  - tests/synthetic/conftest.py
  - tests/synthetic/test_full_pipeline.py
  - tests/unit/test_interface_estimation.py
  - tests/unit/test_reprojection.py
  - tests/unit/test_refinement.py
  - tests/unit/test_datasets.py
autonomous: true

must_haves:
  truths:
    - "generate_synthetic_rig('small') returns a SyntheticScenario with 2 cameras and 10 frames"
    - "generate_synthetic_rig('medium') returns a SyntheticScenario with 6 cameras and 80 frames"
    - "generate_synthetic_rig('large') returns a SyntheticScenario with 13 cameras and 300 frames"
    - "Calling the same preset twice produces identical results (fixed seed reproducibility)"
    - "generate_synthetic_rig('small', include_images=True) returns scenario with rendered images dict"
    - "Existing synthetic and unit tests pass without modification to test logic"
  artifacts:
    - path: "src/aquacal/datasets/__init__.py"
      provides: "Public API exports: generate_synthetic_rig"
      contains: "generate_synthetic_rig"
    - path: "src/aquacal/datasets/synthetic.py"
      provides: "Synthetic rig generation with presets and image rendering"
      contains: "def generate_synthetic_rig"
    - path: "src/aquacal/datasets/rendering.py"
      provides: "Synthetic ChArUco image rendering with refractive projection"
      contains: "def render_synthetic_frame"
    - path: "tests/unit/test_datasets.py"
      provides: "Tests for synthetic data API"
      contains: "test_generate_synthetic_rig"
  key_links:
    - from: "src/aquacal/datasets/synthetic.py"
      to: "aquacal.core.refractive_geometry"
      via: "refractive_project for detection generation"
      pattern: "from aquacal.core.refractive_geometry import"
    - from: "src/aquacal/datasets/rendering.py"
      to: "aquacal.core.refractive_geometry"
      via: "refractive_project for image rendering"
      pattern: "from aquacal.core.refractive_geometry import"
    - from: "tests/synthetic/ground_truth.py"
      to: "aquacal.datasets.synthetic"
      via: "imports refactored functions from public API"
      pattern: "from aquacal.datasets.synthetic import"
---

<objective>
Refactor synthetic data generation from test helpers into the public `aquacal.datasets` API and add synthetic image rendering.

Purpose: Researchers need a zero-config way to generate synthetic calibration data with known ground truth for testing and validating AquaCal. The existing `tests/synthetic/ground_truth.py` already has excellent generation code — this plan moves it into the public API with fixed presets and adds image rendering.

Output: `aquacal.datasets.synthetic` module with `generate_synthetic_rig()` function, image rendering, and updated tests.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-example-data/04-CONTEXT.md
@.planning/phases/04-example-data/04-RESEARCH.md
@tests/synthetic/ground_truth.py
@src/aquacal/config/schema.py
@src/aquacal/core/refractive_geometry.py
@src/aquacal/core/board.py
@src/aquacal/core/camera.py
@src/aquacal/core/interface_model.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create aquacal.datasets module with generate_synthetic_rig() and rendering</name>
  <files>
    src/aquacal/datasets/__init__.py
    src/aquacal/datasets/synthetic.py
    src/aquacal/datasets/rendering.py
  </files>
  <action>
Create the `src/aquacal/datasets/` package with three files:

**`synthetic.py`** — Core synthetic data generation:
- Copy these functions from `tests/synthetic/ground_truth.py` into this module:
  - `SyntheticScenario` dataclass (add optional `images: dict[str, dict[int, NDArray]] | None = None` field)
  - `generate_camera_intrinsics()`
  - `generate_camera_array()`
  - `generate_real_rig_array()`
  - `generate_board_trajectory()`
  - `generate_real_rig_trajectory()`
  - `generate_synthetic_detections()`
  - `compute_calibration_errors()`
- Create `generate_synthetic_rig(preset: str, *, include_images: bool = False, noisy: bool = False) -> SyntheticScenario`:
  - Three fixed presets with NO custom configuration (per user decision):
    - `'small'`: 2 cameras, line layout, 10 frames, seed=42. Clean by default. Board: 12x9 ChArUco, 60mm squares, 45mm markers, DICT_5X5_100 (matching existing test board config).
    - `'medium'`: 6 cameras, grid layout, 80 frames, seed=123. Clean by default.
    - `'large'`: 13 cameras (real rig geometry via `generate_real_rig_array()`), 300 frames, seed=456. Clean by default.
  - `noisy=True` adds Gaussian pixel jitter: small=0.3px, medium=0.5px, large=0.5px
  - Calls `generate_synthetic_detections()` to produce detections
  - If `include_images=True`, calls rendering functions to produce images dict
  - Returns `SyntheticScenario` with all ground truth + detections populated
  - Raise `ValueError` for unknown preset with list of valid presets

**`rendering.py`** — Synthetic ChArUco image rendering:
- `render_synthetic_frame(camera_intrinsics, camera_extrinsics, board_pose, board_geometry, interface, image_size, underwater=True) -> NDArray`:
  - If `underwater=True`: Project 3D board corners through refractive interface using `refractive_project()`, then draw checkerboard pattern at projected positions
  - If `underwater=False` (in-air): Use standard pinhole projection (no refraction)
  - Rendering approach: Black background (uint8), draw white/gray filled quads for checkerboard squares using `cv2.fillPoly()`, draw circles at corner positions
  - Full frame at camera resolution (e.g. 1920x1080), NOT cropped
  - Return grayscale uint8 image
- `render_scenario_images(scenario: SyntheticScenario) -> dict[str, dict[int, NDArray]]`:
  - Renders all frames for all cameras in a scenario
  - Returns nested dict: camera_name -> frame_idx -> image
  - Only renders frames where the board is visible (has detections)

**`__init__.py`** — Public API exports:
- Export `generate_synthetic_rig` and `SyntheticScenario`
- Module docstring explaining the datasets API with usage examples
- Do NOT export internal helpers (generate_camera_array, etc.)

Design notes:
- Board config for all presets: 12x9 ChArUco, 60mm squares, 45mm markers, DICT_5X5_100 (matching existing test infrastructure, per research recommendation)
- The `noisy` parameter name is cleaner than exposing noise_std values. Clean by default per user decision.
- Keep `generate_synthetic_detections()` as the internal workhorse — it already handles projection, noise, and filtering correctly
  </action>
  <verify>
Run: `python -c "from aquacal.datasets import generate_synthetic_rig, SyntheticScenario; s = generate_synthetic_rig('small'); print(f'Cameras: {len(s.intrinsics)}, Frames: {len(s.board_poses)}'); s2 = generate_synthetic_rig('small'); assert all((s.intrinsics[k].K == s2.intrinsics[k].K).all() for k in s.intrinsics), 'Not reproducible'; print('Reproducible: OK')"`

Run: `python -c "from aquacal.datasets import generate_synthetic_rig; s = generate_synthetic_rig('small', include_images=True); print(f'Images: {len(s.images)} cameras'); print(f'Image shape: {list(s.images.values())[0][list(list(s.images.values())[0].keys())[0]].shape}')"`
  </verify>
  <done>
- `generate_synthetic_rig()` works for all three presets ('small', 'medium', 'large')
- Same preset with same defaults produces identical output (reproducibility)
- `include_images=True` generates grayscale images at full camera resolution
- `noisy=True` adds pixel noise to detections
- ValueError raised for unknown preset names
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor test files to import from public API and add dataset tests</name>
  <files>
    tests/synthetic/ground_truth.py
    tests/synthetic/conftest.py
    tests/synthetic/test_full_pipeline.py
    tests/unit/test_interface_estimation.py
    tests/unit/test_reprojection.py
    tests/unit/test_refinement.py
    tests/unit/test_datasets.py
  </files>
  <action>
**Refactor `tests/synthetic/ground_truth.py`:**
- Remove the copied functions (generate_camera_intrinsics, generate_camera_array, generate_real_rig_array, generate_board_trajectory, generate_real_rig_trajectory, generate_synthetic_detections, SyntheticScenario, compute_calibration_errors)
- Replace with imports from `aquacal.datasets.synthetic`:
  ```python
  from aquacal.datasets.synthetic import (
      SyntheticScenario,
      generate_camera_intrinsics,
      generate_camera_array,
      generate_real_rig_array,
      generate_board_trajectory,
      generate_real_rig_trajectory,
      generate_dense_xy_grid,
      generate_synthetic_detections,
      compute_calibration_errors,
  )
  ```
- Keep `create_scenario()` function in the test file as a thin wrapper that calls `generate_synthetic_rig()` with mapped preset names (ideal->small is NOT a direct map since params differ; keep create_scenario as-is but calling the refactored internal functions imported from the public module)
- Actually, better approach: keep `create_scenario()` in ground_truth.py but have it call the imported helper functions. The test presets (ideal, minimal, realistic) have DIFFERENT parameters than the public presets (small, medium, large), so keep both. The test file becomes a thin wrapper that imports all generation functions from `aquacal.datasets.synthetic` and only defines `create_scenario()` and the test-specific preset logic.
- Keep `generate_dense_xy_grid()` accessible — it's used in tests but not needed in public API

**Update test imports:**
- `tests/synthetic/conftest.py`: Keep importing from `.ground_truth` (no change needed since ground_truth.py still re-exports everything)
- `tests/synthetic/test_full_pipeline.py`: Same — keep importing from `.ground_truth`
- `tests/unit/test_interface_estimation.py`: Keep importing `generate_synthetic_detections` from `tests.synthetic.ground_truth`
- `tests/unit/test_reprojection.py`: Same
- `tests/unit/test_refinement.py`: Same
- The key is that `tests/synthetic/ground_truth.py` re-exports everything from the public API, so downstream test imports don't need to change.

**Create `tests/unit/test_datasets.py`:**
- `test_generate_synthetic_rig_small()`: Verify small preset returns 2 cameras, 10 frames
- `test_generate_synthetic_rig_medium()`: Verify medium preset returns 6 cameras, 80 frames
- `test_generate_synthetic_rig_large()`: Mark `@pytest.mark.slow`. Verify large preset returns 13 cameras, 300 frames
- `test_generate_synthetic_rig_reproducibility()`: Call same preset twice, verify intrinsics/extrinsics/detections are identical
- `test_generate_synthetic_rig_noisy()`: Verify noisy=True produces different detections than clean
- `test_generate_synthetic_rig_invalid_preset()`: Verify ValueError for unknown preset
- `test_generate_synthetic_rig_with_images()`: Verify images dict structure, image shape matches camera resolution, dtype is uint8
- `test_render_synthetic_frame()`: Test individual frame rendering produces correct-sized grayscale image
  </action>
  <verify>
Run: `python -m pytest tests/unit/test_datasets.py -v`
Run: `python -m pytest tests/ -m "not slow" --tb=short` (all existing tests still pass)
  </verify>
  <done>
- All new dataset tests pass
- All existing synthetic and unit tests pass without modification to their test logic
- tests/synthetic/ground_truth.py is a thin re-export wrapper, no duplicate code
- No test file imports broke during refactoring
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/unit/test_datasets.py -v` — all dataset tests pass
2. `python -m pytest tests/ -m "not slow" --tb=short` — no regressions in existing tests
3. `python -c "from aquacal.datasets import generate_synthetic_rig; s = generate_synthetic_rig('small'); print('OK')"` — public API importable
4. `python -c "from aquacal.datasets import generate_synthetic_rig; s = generate_synthetic_rig('small', include_images=True); assert s.images is not None; print('Images OK')"` — image rendering works
</verification>

<success_criteria>
- generate_synthetic_rig() works for all three presets with correct camera/frame counts
- Fixed seed reproducibility: same preset always generates identical data
- include_images=True renders grayscale images at full camera resolution
- noisy=True adds Gaussian pixel jitter to detections
- All existing tests pass (no regressions from refactoring)
- New dataset tests validate the public API
</success_criteria>

<output>
After completion, create `.planning/phases/04-example-data/04-01-SUMMARY.md`
</output>
