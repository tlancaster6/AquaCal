---
phase: 04-example-data
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/aquacal/datasets/__init__.py
  - src/aquacal/datasets/loader.py
  - src/aquacal/datasets/download.py
  - src/aquacal/datasets/_manifest.py
  - src/aquacal/datasets/data/manifest.json
  - src/aquacal/datasets/data/small/detections.json
  - src/aquacal/datasets/data/small/ground_truth.json
  - pyproject.toml
  - tests/unit/test_datasets.py
autonomous: true

must_haves:
  truths:
    - "load_example('small') returns an ExampleDataset instantly without any download"
    - "load_example('medium') raises a clear error explaining the dataset must be downloaded from Zenodo (placeholder until real Zenodo IDs exist)"
    - "Small preset data is included in the installed package (ships with pip install)"
    - "Cache directory ./aquacal_data/ is created with .gitignore when download is attempted"
    - "requests and tqdm are listed as dependencies in pyproject.toml"
  artifacts:
    - path: "src/aquacal/datasets/loader.py"
      provides: "load_example() function and ExampleDataset dataclass"
      contains: "def load_example"
    - path: "src/aquacal/datasets/download.py"
      provides: "Download with progress bar, checksum validation, cache management"
      contains: "def download_with_progress"
    - path: "src/aquacal/datasets/_manifest.py"
      provides: "Manifest loading and dataset registry"
      contains: "def get_manifest"
    - path: "src/aquacal/datasets/data/manifest.json"
      provides: "Dataset metadata including Zenodo URLs and checksums"
      contains: "small"
    - path: "src/aquacal/datasets/data/small/detections.json"
      provides: "Pre-generated small preset detection data"
    - path: "pyproject.toml"
      provides: "Updated dependencies and package-data config"
      contains: "requests"
  key_links:
    - from: "src/aquacal/datasets/loader.py"
      to: "src/aquacal/datasets/_manifest.py"
      via: "Reads manifest to determine dataset source"
      pattern: "get_manifest"
    - from: "src/aquacal/datasets/loader.py"
      to: "src/aquacal/datasets/download.py"
      via: "Downloads non-included datasets"
      pattern: "download_with_progress"
    - from: "src/aquacal/datasets/__init__.py"
      to: "src/aquacal/datasets/loader.py"
      via: "Exports load_example and ExampleDataset"
      pattern: "from .loader import"
---

<objective>
Build the dataset loading, downloading, and caching infrastructure so users can load example datasets via `load_example()`.

Purpose: Researchers need a single function to access any dataset — included small preset loads instantly, larger datasets download from Zenodo with progress indication. The small preset ships in-package for zero-download quick start.

Output: `load_example()` API, download infrastructure, manifest system, in-package small preset data, updated pyproject.toml.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-example-data/04-CONTEXT.md
@.planning/phases/04-example-data/04-RESEARCH.md
@.planning/phases/04-example-data/04-01-SUMMARY.md
@src/aquacal/datasets/__init__.py
@src/aquacal/datasets/synthetic.py
@src/aquacal/config/schema.py
@src/aquacal/io/serialization.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create loader, download, and manifest modules with in-package small preset</name>
  <files>
    src/aquacal/datasets/loader.py
    src/aquacal/datasets/download.py
    src/aquacal/datasets/_manifest.py
    src/aquacal/datasets/data/manifest.json
    src/aquacal/datasets/data/small/detections.json
    src/aquacal/datasets/data/small/ground_truth.json
    src/aquacal/datasets/__init__.py
  </files>
  <action>
**Create `src/aquacal/datasets/data/` directory** for in-package data files.

**Generate small preset data files:**
- Write a helper script (or inline in the build step) that calls `generate_synthetic_rig('small')` and serializes:
  - `data/small/detections.json`: Serialized `DetectionResult` with all frame detections. Use the serialization pattern from `aquacal/io/serialization.py` (numpy arrays to lists, version header).
  - `data/small/ground_truth.json`: Serialized ground truth (intrinsics, extrinsics, interface_distances, board_config, board_poses, noise_std). Same serialization pattern.
- These are STATIC files checked into the repo — generated once, not at install time.
- Small preset images are NOT included in-package (too large). Users get images via `generate_synthetic_rig('small', include_images=True)` instead.

**Create `src/aquacal/datasets/data/manifest.json`:**
```json
{
  "version": "1.0",
  "datasets": {
    "small": {
      "type": "synthetic",
      "included": true,
      "description": "2 cameras, 10 frames — ships with package, no download needed"
    },
    "medium": {
      "type": "synthetic",
      "included": false,
      "zenodo_record_id": null,
      "zenodo_filename": "synthetic-medium.zip",
      "checksum_sha256": null,
      "size_bytes": null,
      "description": "6 cameras, 80 frames — download from Zenodo"
    },
    "large": {
      "type": "synthetic",
      "included": false,
      "zenodo_record_id": null,
      "zenodo_filename": "synthetic-large.zip",
      "checksum_sha256": null,
      "size_bytes": null,
      "description": "13 cameras, 300 frames — download from Zenodo"
    },
    "real-rig": {
      "type": "real",
      "included": false,
      "zenodo_record_id": null,
      "zenodo_filename": "real-rig.zip",
      "checksum_sha256": null,
      "size_bytes": null,
      "description": "9+ camera production rig — download from Zenodo"
    }
  }
}
```
Note: `zenodo_record_id`, `checksum_sha256`, and `size_bytes` are null placeholders. They will be populated when datasets are actually uploaded to Zenodo (Plan 03 or future work).

**Create `src/aquacal/datasets/_manifest.py`:**
- `get_manifest() -> dict`: Load manifest.json using `importlib.resources.files("aquacal.datasets").joinpath("data/manifest.json")`
- `get_dataset_info(name: str) -> dict`: Return info for named dataset, raise `ValueError` with available names if not found
- `list_datasets() -> list[str]`: Return list of available dataset names

**Create `src/aquacal/datasets/download.py`:**
- `get_cache_dir() -> Path`: Returns `Path.cwd() / "aquacal_data"`, creates it if needed, writes `.gitignore` containing `*\n` if missing
- `download_with_progress(url: str, dest: Path, expected_sha256: str | None = None, max_retries: int = 3) -> None`:
  - Uses `requests.get(url, stream=True, timeout=30)`
  - tqdm progress bar with bytes display
  - SHA256 checksum validation after download (if expected_sha256 provided)
  - Retry with exponential backoff (1s, 2s, 4s) on failure
  - Delete partial file on checksum mismatch
  - Raise `RuntimeError` after max retries exhausted
- `download_and_extract(dataset_name: str, dataset_info: dict) -> Path`:
  - Constructs Zenodo URL: `https://zenodo.org/records/{record_id}/files/{filename}`
  - Downloads ZIP to `aquacal_data/downloads/{filename}`
  - Extracts to `aquacal_data/{dataset_name}/`
  - Returns path to extracted directory
  - Skips download if extracted directory already exists (cache hit)
- `clear_cache(dataset_name: str | None = None) -> None`:
  - If name provided, remove that dataset's extracted dir and zip
  - If None, remove entire `aquacal_data/` directory
- `get_cache_info() -> dict`:
  - Returns cache_dir path, list of cached datasets, total size in MB

**Create `src/aquacal/datasets/loader.py`:**
- Define `ExampleDataset` dataclass:
  ```python
  @dataclass
  class ExampleDataset:
      name: str
      type: str  # "synthetic" or "real"
      detections: DetectionResult
      ground_truth: SyntheticScenario | None = None
      reference_calibration: CalibrationResult | None = None
      metadata: dict = field(default_factory=dict)
      cache_path: Path | None = None
  ```
- `load_example(name: str) -> ExampleDataset`:
  - Call `get_dataset_info(name)` to get manifest entry
  - If `included=true` (small preset):
    - Load from package data using `importlib.resources`
    - Deserialize detections.json and ground_truth.json
    - Return ExampleDataset with ground_truth populated, cache_path=None
  - If `included=false`:
    - Check if zenodo_record_id is None — if so, raise `NotImplementedError` with message: "Dataset '{name}' is not yet available for download. Use generate_synthetic_rig('{name}') to generate it locally."
    - Otherwise: call `download_and_extract()`, load from extracted files, return ExampleDataset
  - Deserialization helpers: `_deserialize_detections(data: dict) -> DetectionResult` and `_deserialize_ground_truth(data: dict) -> SyntheticScenario` — reverse the serialization format

**Update `src/aquacal/datasets/__init__.py`:**
- Add exports: `load_example`, `ExampleDataset`, `clear_cache`, `get_cache_info`, `list_datasets`
- Keep existing exports from Plan 01: `generate_synthetic_rig`, `SyntheticScenario`
  </action>
  <verify>
Run: `python -c "from aquacal.datasets import load_example, list_datasets; print(list_datasets()); ds = load_example('small'); print(f'Loaded: {ds.name}, type={ds.type}, cameras={len(ds.ground_truth.intrinsics)}')"` — small loads instantly

Run: `python -c "from aquacal.datasets import load_example; load_example('medium')"` — should raise NotImplementedError with helpful message
  </verify>
  <done>
- load_example('small') returns ExampleDataset with detections and ground truth, no download needed
- load_example('medium') raises NotImplementedError with clear message about Zenodo availability
- list_datasets() returns ['small', 'medium', 'large', 'real-rig']
- Small preset data files exist in src/aquacal/datasets/data/small/
- Manifest file correctly lists all datasets with included/download status
  </done>
</task>

<task type="auto">
  <name>Task 2: Update pyproject.toml and add loader tests</name>
  <files>
    pyproject.toml
    tests/unit/test_datasets.py
  </files>
  <action>
**Update `pyproject.toml`:**

1. Add `requests` and `tqdm` to dependencies:
```toml
dependencies = [
    "numpy",
    "scipy",
    "opencv-python>=4.6",
    "pyyaml",
    "matplotlib",
    "pandas",
    "requests",
    "tqdm",
]
```

2. Add package-data configuration:
```toml
[tool.setuptools.package-data]
aquacal = [
    "datasets/data/**/*.json",
]
```

**Add tests to `tests/unit/test_datasets.py`** (append to existing file from Plan 01):

- `test_load_example_small()`: Call `load_example('small')`, verify returns ExampleDataset with correct name, type="synthetic", non-None ground_truth, non-None detections, cache_path=None
- `test_load_example_small_detections_match_generated()`: Load small preset via `load_example('small')` and generate via `generate_synthetic_rig('small')` — verify detection counts match (same underlying data)
- `test_load_example_nonexistent()`: Verify `load_example('nonexistent')` raises ValueError
- `test_load_example_medium_not_available()`: Verify `load_example('medium')` raises NotImplementedError with helpful message
- `test_list_datasets()`: Verify returns list containing 'small', 'medium', 'large', 'real-rig'
- `test_get_cache_dir(tmp_path, monkeypatch)`: Monkeypatch `Path.cwd()` to tmp_path, call `get_cache_dir()`, verify directory created with `.gitignore`
- `test_clear_cache(tmp_path, monkeypatch)`: Create fake cache structure, verify `clear_cache()` removes it
- `test_manifest_loading()`: Verify `get_manifest()` returns valid dict with expected structure

**Verify package data inclusion:**
Run `python -m build --wheel` and inspect wheel contents to confirm datasets/data/ files are included.
  </action>
  <verify>
Run: `python -m pytest tests/unit/test_datasets.py -v --tb=short`
Run: `python -m pytest tests/ -m "not slow" --tb=short` (no regressions)
Run: `python -c "import aquacal.datasets; print(dir(aquacal.datasets))"` — verify all public names exported
  </verify>
  <done>
- All loader tests pass
- pyproject.toml has requests and tqdm in dependencies
- pyproject.toml has package-data config for datasets/data/
- All existing tests still pass
- Public API exports: generate_synthetic_rig, SyntheticScenario, load_example, ExampleDataset, list_datasets, clear_cache, get_cache_info
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/unit/test_datasets.py -v` — all dataset and loader tests pass
2. `python -m pytest tests/ -m "not slow" --tb=short` — no regressions
3. `python -c "from aquacal.datasets import load_example; ds = load_example('small'); print(f'{ds.name}: {len(ds.ground_truth.intrinsics)} cameras')"` — loads from package data
4. `python -c "from aquacal.datasets import list_datasets; print(list_datasets())"` — lists all datasets
5. Verify `src/aquacal/datasets/data/small/detections.json` exists and is valid JSON
</verification>

<success_criteria>
- load_example('small') works instantly from in-package data
- load_example('medium') gives clear NotImplementedError (Zenodo not yet configured)
- Download infrastructure (download.py) is ready for when Zenodo records are created
- Cache management (get_cache_dir, clear_cache, get_cache_info) works correctly
- Package data configuration ensures small preset ships with pip install
- requests and tqdm added as dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/04-example-data/04-02-SUMMARY.md`
</output>
