---
phase: 13-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/aquacal/__init__.py
  - .github/workflows/test.yml
  - .github/workflows/slow-tests.yml
autonomous: true

must_haves:
  truths:
    - "`pip install aquacal` also installs aquakit as a transitive dependency"
    - "Importing aquacal when PyTorch is not installed raises a clear ImportError with install instructions"
    - "CI installs CPU-only PyTorch and runs tests successfully with aquakit present"
  artifacts:
    - path: "pyproject.toml"
      provides: "aquakit dependency declaration"
      contains: "aquakit>=1.0,<2"
    - path: "src/aquacal/__init__.py"
      provides: "Import-time torch check"
      contains: "ImportError"
    - path: ".github/workflows/test.yml"
      provides: "CI torch install step"
      contains: "pip install torch"
    - path: ".github/workflows/slow-tests.yml"
      provides: "Slow-tests torch install step"
      contains: "pip install torch"
  key_links:
    - from: "src/aquacal/__init__.py"
      to: "torch"
      via: "import check before aquakit imports"
      pattern: "import torch"
---

<objective>
Add AquaKit as a hard dependency of AquaCal and implement the import-time PyTorch check. Update CI to install CPU-only torch.

Purpose: After this plan, `pip install aquacal` pulls in aquakit, and missing torch produces a clear, actionable error at `import aquacal` time. CI is updated to include torch so tests pass.
Output: Updated pyproject.toml, __init__.py, and CI workflow files.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@pyproject.toml
@src/aquacal/__init__.py
@.github/workflows/test.yml
@.github/workflows/slow-tests.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add aquakit dependency and import-time torch check</name>
  <files>pyproject.toml, src/aquacal/__init__.py</files>
  <action>
1. In `pyproject.toml`, add `"aquakit>=1.0,<2"` to the `dependencies` list (after the existing entries).

2. In `src/aquacal/__init__.py`, add a torch presence check at the TOP of the file, BEFORE the existing imports (but after the docstring). The check should:
   - Try `import torch` in a try/except block
   - On `ModuleNotFoundError`, raise `ImportError` with this message:
     "AquaCal requires PyTorch. Install it first: `pip install torch`. See https://pytorch.org/get-started/ for GPU variants."
   - Use a `_check_torch()` helper function for clean organization
   - Call `_check_torch()` immediately after defining it (before `from importlib.metadata import version`)

The exact pattern:
```python
"""AquaCal: Refractive multi-camera calibration library."""


def _check_torch():
    """Verify PyTorch is installed before importing aquakit."""
    try:
        import torch  # noqa: F401
    except ModuleNotFoundError:
        raise ImportError(
            "AquaCal requires PyTorch. Install it first: `pip install torch`. "
            "See https://pytorch.org/get-started/ for GPU variants."
        ) from None


_check_torch()

from importlib.metadata import version as _get_version
# ... rest of existing imports ...
```
  </action>
  <verify>
Run `python -c "import aquacal"` — should succeed if torch is installed.
Run `python -m pytest tests/unit/test_camera.py -v` — verify tests still pass with the new init.
  </verify>
  <done>pyproject.toml declares aquakit>=1.0,<2 in dependencies. `import aquacal` checks for torch and raises clear ImportError if missing.</done>
</task>

<task type="auto">
  <name>Task 2: Update CI workflows to install CPU-only PyTorch</name>
  <files>.github/workflows/test.yml, .github/workflows/slow-tests.yml</files>
  <action>
In both `.github/workflows/test.yml` and `.github/workflows/slow-tests.yml`, add a torch install step in the "Install dependencies" section. The torch install must come BEFORE `pip install -e ".[dev]"` so that when aquakit is installed as a transitive dependency, torch is already present.

For both files, update the "Install dependencies" step to:
```yaml
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          pip install -e ".[dev]"
```

This installs CPU-only torch (much smaller/faster than full torch) before installing aquacal and its dependencies.
  </action>
  <verify>Review the YAML files to confirm the torch install line is present and correctly placed before the editable install.</verify>
  <done>Both test.yml and slow-tests.yml install CPU-only torch before installing aquacal dependencies.</done>
</task>

</tasks>

<verification>
1. `pip install -e .` installs aquakit (check with `pip show aquakit`)
2. `python -c "import aquacal; print(aquacal.__version__)"` succeeds
3. CI YAML files contain the torch CPU install line
</verification>

<success_criteria>
- pyproject.toml has aquakit>=1.0,<2 in dependencies
- `import aquacal` raises clear ImportError when torch is missing
- CI workflows install CPU-only torch before running tests
</success_criteria>

<output>
After completion, create `.planning/phases/13-setup/13-01-SUMMARY.md`
</output>
