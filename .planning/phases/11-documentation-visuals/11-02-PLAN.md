---
phase: 11-documentation-visuals
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - pyproject.toml
  - docs/conf.py
  - docs/guide/optimizer.md
  - docs/_static/scripts/sparsity_pattern.py
  - docs/_static/scripts/bfs_pose_graph.py
  - docs/_static/diagrams/sparsity_pattern.png
  - docs/_static/diagrams/bfs_pose_graph.png
  - docs/guide/_diagrams/generate_all.py
autonomous: false

must_haves:
  truths:
    - "Pipeline ASCII diagram in optimizer.md is replaced with a Mermaid flowchart"
    - "Sparse Jacobian section has an illustrative sparsity pattern diagram"
    - "Stage 2 section has a BFS pose graph diagram showing camera-board connectivity"
    - "User confirms visuals improve documentation clarity"
  artifacts:
    - path: "docs/guide/optimizer.md"
      provides: "Updated optimizer page with Mermaid pipeline and new diagram references"
      contains: "mermaid"
    - path: "docs/_static/diagrams/sparsity_pattern.png"
      provides: "Block-sparse Jacobian pattern visualization"
    - path: "docs/_static/diagrams/bfs_pose_graph.png"
      provides: "BFS pose graph visualization"
    - path: "docs/conf.py"
      provides: "Sphinx config with sphinxcontrib-mermaid extension"
      contains: "sphinxcontrib.mermaid"
  key_links:
    - from: "docs/guide/optimizer.md"
      to: "docs/_static/diagrams/sparsity_pattern.png"
      via: "markdown image reference"
    - from: "docs/guide/optimizer.md"
      to: "docs/_static/diagrams/bfs_pose_graph.png"
      via: "markdown image reference"
---

<objective>
Add new visual aids to the optimizer documentation page: replace the ASCII pipeline diagram with a Mermaid flowchart, add a sparsity pattern illustration, and add a BFS pose graph diagram.

Purpose: Replace text-heavy explanations with visual aids that help users understand the calibration pipeline flow, Jacobian structure, and pose graph connectivity.

Output: Updated optimizer.md with Mermaid diagram, two new PNG diagrams, Mermaid Sphinx extension configured.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-documentation-visuals/11-CONTEXT.md
@.planning/phases/11-documentation-visuals/11-01-SUMMARY.md
@docs/guide/optimizer.md
@docs/conf.py
@docs/_static/scripts/palette.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Mermaid support, create new diagrams, update optimizer.md</name>
  <files>
    pyproject.toml
    docs/conf.py
    docs/guide/optimizer.md
    docs/_static/scripts/sparsity_pattern.py
    docs/_static/scripts/bfs_pose_graph.py
    docs/_static/diagrams/sparsity_pattern.png
    docs/_static/diagrams/bfs_pose_graph.png
    docs/guide/_diagrams/generate_all.py
  </files>
  <action>
**1. Add sphinxcontrib-mermaid dependency:**

In `pyproject.toml`, add `sphinxcontrib-mermaid` to the `docs` extras group (find the existing docs dependencies list and append it).

Install it: `pip install sphinxcontrib-mermaid`

In `docs/conf.py`, add `"sphinxcontrib.mermaid"` to the `extensions` list.

**2. Replace ASCII pipeline diagram with Mermaid in optimizer.md:**

Find the ASCII code block (lines 9-27 of optimizer.md, the ```...``` block showing Stage 1 → Stage 2 → Stage 3 → Stage 4). Replace it with a Mermaid diagram block:

Per user decision: horizontal left-to-right flow, full detail with abbreviated inputs/outputs per stage matching current ASCII content. Use MyST fence syntax:

```{mermaid}
flowchart LR
    S1["**Stage 1**<br/>In-air Intrinsics<br/><small>(OpenCV)</small>"]
    S2["**Stage 2**<br/>Extrinsic Init<br/><small>(BFS/PnP)</small>"]
    S3["**Stage 3**<br/>Joint Refractive BA<br/><small>(nonlinear)</small>"]
    S4["**Stage 4**<br/>Intrinsic Refinement<br/><small>(optional)</small>"]

    S1 -->|"K, dist"| S2
    S2 -->|"R,t, water_z,<br/>board poses"| S3
    S3 -->|"refined params"| S4

    I1["In-air videos<br/>Board params"] --> S1
    I2["Underwater videos<br/>Intrinsics"] --> S2
    S4 --> O["Refined K, R, t<br/>water_z, boards"]
```

Adjust exact Mermaid syntax as needed to render well. Use the MyST colon-fence `:::` or triple-backtick ```` ```{mermaid} ```` syntax (the project uses myst_parser with colon_fence extension).

**3. Create sparsity pattern diagram script:**

`docs/_static/scripts/sparsity_pattern.py` — A matplotlib script that visualizes the block-sparse Jacobian structure for a small example (3 cameras, 3 frames) as described in the user decisions.

- Import colors from `palette.py` (use sys.path insert pattern)
- Create a matplotlib figure showing a spy-plot-like visualization of the Jacobian sparsity pattern
- Rows = residuals (grouped by camera-frame pairs), columns = parameters (extrinsics | water_z | board poses)
- Use colored blocks: one color for extrinsic params, one for water_z, one for board pose params
- Add axis labels: "Residuals (camera-frame pairs)" on Y, parameter groups on X
- Add a simple legend or column headers identifying the parameter blocks
- Small illustrative example: 3 cameras (cam0 ref + cam1 + cam2), 3 frames, ~6-10 observations total
- The pattern should clearly show that each residual row only touches its camera's extrinsics + water_z + its frame's board pose (block-diagonal structure with water_z column dense)
- Save as `docs/_static/diagrams/sparsity_pattern.png` at 150 DPI
- Include `def generate(output_dir)` function

**4. Create BFS pose graph diagram:**

`docs/_static/scripts/bfs_pose_graph.py` — Use matplotlib with networkx to draw a small pose graph. Per user decisions, format is Claude's discretion; matplotlib/networkx is a good fit.

- Show 4 cameras (cam0, cam1, cam2, cam3) as nodes in one color
- Show 3 frames (F1, F2, F3) as board-shaped nodes in another color
- Edges connect cameras to frames they observe (not all cameras see all frames)
- Example connectivity: cam0-F1, cam0-F2, cam1-F2, cam1-F3, cam2-F1, cam2-F3, cam3-F3
  (This shows cam0 and cam1 connected through F2, cam1 and cam2 through F3, etc.)
- Highlight BFS traversal path from cam0 (reference) with arrows or edge colors
- Import colors from palette.py
- Camera nodes use CAMERA_COLOR, board nodes use BOARD_COLOR
- Save as `docs/_static/diagrams/bfs_pose_graph.png` at 150 DPI
- Include `def generate(output_dir)` function

**5. Update generate_all.py:**

Add imports and calls for the two new diagram scripts (sparsity_pattern and bfs_pose_graph). Add sys.path manipulation to find `docs/_static/scripts/`. Also add the hero_image generation call.

**6. Add image references in optimizer.md:**

- In the "Stage 2: Extrinsic Initialization" section, after the introductory paragraph about BFS, add:
  ```
  ![BFS pose graph](../_static/diagrams/bfs_pose_graph.png)
  ```

- In the "Sparse Jacobian Strategy" > "Block-Sparse Structure" subsection, after the description of what each residual depends on, add:
  ```
  ![Jacobian sparsity pattern](../_static/diagrams/sparsity_pattern.png)
  ```

Generate both new diagrams:
```bash
python docs/_static/scripts/sparsity_pattern.py
python docs/_static/scripts/bfs_pose_graph.py
```
  </action>
  <verify>
```bash
pip install sphinxcontrib-mermaid
python docs/_static/scripts/sparsity_pattern.py
python docs/_static/scripts/bfs_pose_graph.py
ls -la docs/_static/diagrams/sparsity_pattern.png docs/_static/diagrams/bfs_pose_graph.png
grep -c "mermaid" docs/guide/optimizer.md
grep -c "sphinxcontrib.mermaid" docs/conf.py
```
Both PNGs exist, mermaid appears in optimizer.md and conf.py.
  </verify>
  <done>optimizer.md has Mermaid pipeline flowchart replacing ASCII, sparsity pattern PNG referenced in Sparse Jacobian section, BFS pose graph PNG referenced in Stage 2 section. sphinxcontrib-mermaid configured in Sphinx.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: User verifies all documentation visuals</name>
  <action>
Present all Phase 11 documentation visuals for user review:
1. **Hero image** (docs/_static/hero_ray_trace.png) — 3-camera refractive cross-section
2. **Updated ray_trace.png** — Same content, new blue/aqua palette
3. **Updated coordinate_frames.png** — Same content, new blue/aqua palette
4. **Mermaid pipeline diagram** — Horizontal Stage 1-2-3-4 flowchart in optimizer.md
5. **Sparsity pattern diagram** — Block-sparse Jacobian illustration in optimizer.md
6. **BFS pose graph** — Camera-board connectivity graph in optimizer.md
7. **Style guide** (docs/_static/scripts/style_guide.md) — Color palette reference

Verification steps for user:
1. Open `docs/_static/hero_ray_trace.png` — verify it shows 3 cameras above water, rays bending at surface, board below. Should communicate "multi-camera refractive calibration" at a glance. Minimal labels (Camera, Water surface, Board).
2. Open `docs/_static/diagrams/ray_trace.png` — verify colors are consistent with hero image (blue/aqua theme). Content should be unchanged from before.
3. Open `docs/_static/diagrams/coordinate_frames.png` — verify colors are consistent. Content unchanged.
4. Build docs and check optimizer.md page: `cd docs && make html` then open `docs/_build/html/guide/optimizer.html`
   - Pipeline overview section should show a Mermaid flowchart (not ASCII block)
   - Stage 2 section should have a BFS pose graph image
   - Sparse Jacobian section should have a sparsity pattern image
5. Open `docs/_static/diagrams/sparsity_pattern.png` — verify it clearly shows block-sparse structure
6. Open `docs/_static/diagrams/bfs_pose_graph.png` — verify it shows cameras connected through shared board observations
7. Check README renders correctly on GitHub with new hero image

Resume signal: Type "approved" if visuals look good, or describe specific issues to fix.
  </action>
  <verify>User confirms all visuals look good and improve documentation clarity.</verify>
  <done>User has approved all documentation visuals. Phase 11 success criterion "User confirms visuals improve documentation clarity" is met.</done>
</task>

</tasks>

<verification>
- `sphinxcontrib-mermaid` is installed and listed in pyproject.toml docs extras
- `docs/conf.py` includes `"sphinxcontrib.mermaid"` in extensions
- `docs/guide/optimizer.md` no longer contains ASCII pipeline diagram
- `docs/guide/optimizer.md` contains a `{mermaid}` fenced block
- `docs/guide/optimizer.md` references sparsity_pattern.png and bfs_pose_graph.png
- Both new PNGs exist in `docs/_static/diagrams/`
- Sphinx docs build without errors: `cd docs && make html`
- User confirms visuals improve documentation clarity
</verification>

<success_criteria>
The optimizer.md page has three new visual aids (Mermaid pipeline, sparsity pattern, BFS graph). All visuals use the consistent blue/aqua palette. User has verified and approved the visual improvements.
</success_criteria>

<output>
After completion, create `.planning/phases/11-documentation-visuals/11-02-SUMMARY.md`
</output>
