---
phase: 10-documentation-audit
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aquacal/config/schema.py
  - src/aquacal/calibration/pipeline.py
  - src/aquacal/calibration/_optim_common.py
  - src/aquacal/calibration/interface_estimation.py
  - src/aquacal/calibration/refinement.py
  - src/aquacal/calibration/extrinsics.py
  - src/aquacal/core/interface_model.py
  - src/aquacal/core/refractive_geometry.py
  - src/aquacal/io/serialization.py
  - src/aquacal/triangulation/triangulate.py
  - src/aquacal/validation/reprojection.py
  - src/aquacal/validation/comparison.py
  - src/aquacal/validation/diagnostics.py
  - src/aquacal/datasets/synthetic.py
  - src/aquacal/datasets/rendering.py
  - src/aquacal/datasets/loader.py
  - src/aquacal/cli.py
  - docs/guide/coordinates.md
  - docs/guide/refractive_geometry.md
  - tests/unit/test_schema.py
  - tests/unit/test_cli.py
  - tests/unit/test_interface_estimation.py
  - tests/unit/test_interface_model.py
  - tests/unit/test_pipeline.py
  - tests/unit/test_serialization.py
  - tests/unit/test_refractive_geometry.py
  - tests/unit/test_reprojection.py
  - tests/unit/test_triangulate.py
  - tests/unit/test_reconstruction.py
  - tests/unit/test_comparison.py
  - tests/unit/test_diagnostics.py
  - tests/unit/test_extrinsics.py
  - tests/unit/test_datasets.py
  - tests/synthetic/ground_truth.py
  - tests/synthetic/experiment_helpers.py
  - tests/synthetic/experiments.py
  - tests/synthetic/test_full_pipeline.py
autonomous: true
must_haves:
  truths:
    - "The config parameter 'interface_distance' is renamed to 'water_z' everywhere in code, docs, and tests"
    - "All tests pass after the rename"
    - "Generated config YAML uses 'water_z' with an inline comment explaining it"
    - "JSON serialization handles both 'water_z' (new) and 'interface_distance' (legacy) for backward compatibility"
  artifacts:
    - path: "src/aquacal/config/schema.py"
      provides: "CalibrationConfig with water_z field instead of interface_distance"
      contains: "water_z"
    - path: "src/aquacal/calibration/pipeline.py"
      provides: "Config loading that accepts both water_z and interface_distance (backward compat)"
  key_links:
    - from: "src/aquacal/config/schema.py"
      to: "src/aquacal/calibration/pipeline.py"
      via: "water_z field used throughout pipeline"
      pattern: "water_z"
---

<objective>
Rename the `interface_distance` config parameter to `water_z` across the entire codebase: source code, documentation, and tests.

Purpose: Per locked user decision, `interface_distance` is confusing because it's actually the Z-coordinate of the water surface, not a physical distance. `water_z` is clearer and matches the internal variable naming.
Output: All references to `interface_distance` updated to `water_z`; tests passing; backward-compatible JSON loading.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-documentation-audit/10-CONTEXT.md
@.planning/geometry.md
@src/aquacal/config/schema.py
@src/aquacal/calibration/pipeline.py
@src/aquacal/io/serialization.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename interface_distance to water_z in source code</name>
  <files>
    src/aquacal/config/schema.py
    src/aquacal/calibration/pipeline.py
    src/aquacal/calibration/_optim_common.py
    src/aquacal/calibration/interface_estimation.py
    src/aquacal/calibration/refinement.py
    src/aquacal/calibration/extrinsics.py
    src/aquacal/core/interface_model.py
    src/aquacal/core/refractive_geometry.py
    src/aquacal/io/serialization.py
    src/aquacal/triangulation/triangulate.py
    src/aquacal/validation/reprojection.py
    src/aquacal/validation/comparison.py
    src/aquacal/validation/diagnostics.py
    src/aquacal/datasets/synthetic.py
    src/aquacal/datasets/rendering.py
    src/aquacal/datasets/loader.py
    src/aquacal/datasets/data/small/ground_truth.json
    src/aquacal/cli.py
  </files>
  <action>
Rename all occurrences of `interface_distance` to `water_z` across source code.

**Step 1: Schema changes (`config/schema.py`)**
- Rename the `interface_distance` field in `CalibrationConfig` to `water_z`
- Update any docstrings referencing `interface_distance`
- If there's a default value or validation, update accordingly

**Step 2: Pipeline config loading (`calibration/pipeline.py`)**
- Update config loading to use `water_z`
- Add backward compatibility: if YAML contains `interface_distance`, map it to `water_z` and emit a deprecation warning
- Update the `init` command's generated config template to use `water_z` with inline comment: `# Approximate distance from camera rig to water surface (meters)`

**Step 3: Serialization (`io/serialization.py`)**
- Update JSON save to write `water_z`
- Update JSON load to accept both `water_z` (new) and `interface_distance` (legacy) for backward compatibility

**Step 4: All other source files**
- Use grep to find every remaining `interface_distance` reference in `src/aquacal/`
- Rename to `water_z` in: variable names, function parameters, docstrings, comments, log messages
- Files known to contain references: `_optim_common.py`, `interface_estimation.py`, `refinement.py`, `extrinsics.py`, `interface_model.py`, `refractive_geometry.py`, `triangulate.py`, `reprojection.py`, `comparison.py`, `diagnostics.py`, `synthetic.py`, `rendering.py`, `loader.py`, `cli.py`
- Also update `datasets/data/small/ground_truth.json` if it contains the key

**Step 5: Verify no remaining references**
- Run `grep -r "interface_distance" src/aquacal/` to confirm zero matches (except backward-compat code)

**Important:** Do NOT rename the internal variable `water_z` that already exists in some optimization code. The rename is specifically for the config parameter and its propagation through the codebase. Where code already uses `water_z` internally, just update the comments/docstrings that reference `interface_distance`.
  </action>
  <verify>Run `grep -r "interface_distance" src/aquacal/` — should only show backward-compatibility code in pipeline.py and serialization.py. Run `python -m pytest tests/ -x --timeout=60 -m "not slow"` to verify tests still pass (some may fail due to test references, which Task 2 fixes).</verify>
  <done>All source code references to interface_distance renamed to water_z; backward compatibility preserved in config loading and JSON deserialization.</done>
</task>

<task type="auto">
  <name>Task 2: Rename interface_distance to water_z in docs and tests</name>
  <files>
    docs/guide/coordinates.md
    docs/guide/refractive_geometry.md
    docs/tutorials/01_full_pipeline.ipynb
    docs/tutorials/02_diagnostics.ipynb
    docs/tutorials/03_synthetic_validation.ipynb
    tests/unit/test_schema.py
    tests/unit/test_cli.py
    tests/unit/test_interface_estimation.py
    tests/unit/test_interface_model.py
    tests/unit/test_pipeline.py
    tests/unit/test_serialization.py
    tests/unit/test_refractive_geometry.py
    tests/unit/test_reprojection.py
    tests/unit/test_triangulate.py
    tests/unit/test_reconstruction.py
    tests/unit/test_comparison.py
    tests/unit/test_diagnostics.py
    tests/unit/test_extrinsics.py
    tests/unit/test_datasets.py
    tests/synthetic/ground_truth.py
    tests/synthetic/experiment_helpers.py
    tests/synthetic/experiments.py
    tests/synthetic/test_full_pipeline.py
  </files>
  <action>
Rename all occurrences of `interface_distance` to `water_z` in documentation and test files.

**Step 1: Documentation files**
- `docs/guide/coordinates.md` — Update all references
- `docs/guide/refractive_geometry.md` — Update all references
- Jupyter notebooks in `docs/tutorials/` — Update code cells and markdown cells

**Step 2: Test files**
- Use grep to find every `interface_distance` in `tests/`
- Rename in all test files: variable names, assertions, config dicts, docstrings
- Known files: `test_schema.py`, `test_cli.py`, `test_interface_estimation.py`, `test_interface_model.py`, `test_pipeline.py`, `test_serialization.py`, `test_refractive_geometry.py`, `test_reprojection.py`, `test_triangulate.py`, `test_reconstruction.py`, `test_comparison.py`, `test_diagnostics.py`, `test_extrinsics.py`, `test_datasets.py`
- Synthetic test files: `ground_truth.py`, `experiment_helpers.py`, `experiments.py`, `test_full_pipeline.py`

**Step 3: Verify completeness**
- Run `grep -r "interface_distance" tests/ docs/` — should return zero matches
- Add a backward-compat test in `test_serialization.py`: loading a JSON with `interface_distance` key should work and map to `water_z`
- Add a backward-compat test in `test_pipeline.py` or `test_cli.py`: YAML config with `interface_distance` loads successfully with deprecation warning

**Step 4: Run full test suite**
- `python -m pytest tests/ -m "not slow"` — all must pass
  </action>
  <verify>Run `grep -r "interface_distance" tests/ docs/` — zero matches. Run `python -m pytest tests/ -m "not slow" -v` — all tests pass.</verify>
  <done>All test and documentation references to interface_distance renamed to water_z; backward-compat tests added; full test suite passes.</done>
</task>

</tasks>

<verification>
- `grep -r "interface_distance" src/ tests/ docs/` returns only backward-compatibility code
- `python -m pytest tests/ -m "not slow"` passes
- Generated config YAML (from `aquacal init`) uses `water_z` with inline comment
- Loading old JSON with `interface_distance` key works (backward compat)
- Loading old YAML with `interface_distance` key works with deprecation warning
</verification>

<success_criteria>
- Zero unintended references to `interface_distance` remain in codebase
- All tests pass
- Backward compatibility preserved for old config files and saved calibrations
- Generated configs use the new `water_z` name with explanatory comment
</success_criteria>

<output>
After completion, create `.planning/phases/10-documentation-audit/10-02-SUMMARY.md`
</output>
