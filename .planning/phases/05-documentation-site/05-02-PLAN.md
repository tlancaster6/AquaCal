---
phase: 05-documentation-site
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - docs/guide/refractive_geometry.md
  - docs/guide/coordinates.md
  - docs/guide/optimizer.md
  - docs/guide/_diagrams/generate_all.py
  - docs/guide/_diagrams/ray_trace.py
  - docs/guide/_diagrams/coordinate_frames.py
autonomous: true

must_haves:
  truths:
    - "User can read refractive geometry explanation covering Snell's law, ray tracing, and projection model"
    - "User can read coordinate convention documentation covering world frame (Z-down), camera frame (OpenCV), interface normal"
    - "User can read optimizer documentation covering four-stage pipeline, parameter layout, sparse Jacobian strategy, loss functions"
    - "Each theory page is self-contained with brief recaps of prerequisite concepts"
    - "Common pitfalls are highlighted with admonition callouts"
  artifacts:
    - path: "docs/guide/refractive_geometry.md"
      provides: "Snell's law, ray tracing, projection model explanation"
      contains: "snells_law"
    - path: "docs/guide/coordinates.md"
      provides: "World frame, camera frame, interface normal documentation"
      contains: "Z-down"
    - path: "docs/guide/optimizer.md"
      provides: "Four-stage pipeline, parameter layout, sparse Jacobian, loss functions"
      contains: "Stage"
    - path: "docs/guide/_diagrams/ray_trace.py"
      provides: "Matplotlib diagram importing actual AquaCal projection functions"
      contains: "from aquacal"
    - path: "docs/guide/_diagrams/coordinate_frames.py"
      provides: "Coordinate frame visualization diagram"
      contains: "matplotlib"
  key_links:
    - from: "docs/guide/refractive_geometry.md"
      to: "aquacal.core.refractive_geometry"
      via: "{func} cross-references"
    - from: "docs/guide/optimizer.md"
      to: "aquacal.calibration"
      via: "{mod} cross-references"
    - from: "docs/guide/coordinates.md"
      to: "docs/guide/refractive_geometry.md"
      via: "See Also links between theory pages"
---

<objective>
Create the three theory pages (refractive geometry, coordinate conventions, optimizer pipeline) with MathJax equations, matplotlib diagrams generated from actual codebase functions, and "gotcha" admonition callouts.

Purpose: Satisfy requirements THEO-01, THEO-02, THEO-03 — the core educational content that makes AquaCal's documentation useful to researchers.
Output: Three complete theory pages with build-time diagrams, rendering correctly in Sphinx.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-documentation-site/05-01-SUMMARY.md
@.planning/phases/05-documentation-site/05-CONTEXT.md
@.planning/geometry.md
@.planning/architecture.md
@.planning/knowledge-base.md
@src/aquacal/core/refractive_geometry.py
@src/aquacal/core/camera.py
@src/aquacal/core/interface_model.py
@src/aquacal/calibration/_optim_common.py
@src/aquacal/calibration/pipeline.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build-time diagram scripts and refractive geometry theory page</name>
  <files>
    docs/guide/_diagrams/generate_all.py
    docs/guide/_diagrams/ray_trace.py
    docs/guide/_diagrams/coordinate_frames.py
    docs/guide/refractive_geometry.md
  </files>
  <action>
  1. Create `docs/guide/_diagrams/generate_all.py`:
     - Master script that imports and runs all diagram generators
     - Ensures output directory `docs/_static/diagrams/` exists
     - Sets `matplotlib.use('Agg')` for headless rendering
     - Calls each diagram module's `generate()` function

  2. Create `docs/guide/_diagrams/ray_trace.py`:
     - Import actual AquaCal functions: `from aquacal.core.refractive_geometry import snells_law_3d`
     - Generate a 2D cross-section diagram showing:
       - Camera position in air (near Z=0)
       - Water surface line at Z=water_z
       - Incident ray from camera to interface point
       - Refracted ray from interface point to underwater target
       - Angle labels (theta_i, theta_r) with Snell's law annotation
       - Interface normal arrow pointing up [0,0,-1]
       - Air/water labels with refractive indices (n=1.0, n=1.333)
     - Use actual `snells_law_3d` to compute the refracted ray direction for accuracy
     - Save to `docs/_static/diagrams/ray_trace.png`
     - Professional style: clean lines, labeled axes, matplotlib defaults with minor tweaks

  3. Create `docs/guide/_diagrams/coordinate_frames.py`:
     - Generate a 3D perspective diagram showing world coordinate frame axes
     - Show camera position near origin, water surface plane, underwater target region
     - Label +X (right), +Y (forward), +Z (down into water)
     - Mark key Z-values: Z≈0 (cameras), Z=water_z (surface), Z>water_z (targets)
     - Save to `docs/_static/diagrams/coordinate_frames.png`

  4. Create `docs/guide/refractive_geometry.md` (THEO-01):
     - Title: "Refractive Geometry"
     - Brief intro recap: cameras in air, targets underwater, light refracts at interface
     - **Snell's Law** section:
       - Scalar form equation: $n_1 \sin\theta_1 = n_2 \sin\theta_2$
       - 3D vector form equation with explanation of each term
       - Reference to {func}`aquacal.core.refractive_geometry.snells_law_3d`
       - Include the ray trace diagram
     - **Ray Tracing Through the Interface** section:
       - How AquaCal traces a ray from camera through water surface to target
       - The 1D root-finding problem: finding the interface crossing point
       - Brief mention of Newton-Raphson solver approach
       - Reference to {func}`aquacal.core.refractive_geometry.refractive_project`
     - **Projection Model** section:
       - How a 3D world point projects to a 2D pixel via refractive path
       - Comparison with standard pinhole projection (what changes)
       - When refraction matters vs. when pinhole is adequate
     - **Gotcha admonitions** (from knowledge-base.md):
       - `interface_distance` is a Z-coordinate, not a physical camera-to-water gap
       - Interface normal [0,0,-1] points UP (from water toward air)
     - "See Also" links to coordinates.md and optimizer.md
     - Tone: practical guide level, intuition over full derivations, as per user decision
  </action>
  <verify>
  Run `python docs/guide/_diagrams/generate_all.py` — generates PNG files in `docs/_static/diagrams/`. Run `python -m sphinx docs docs/_build -b html -W` — builds without errors. Check that `refractive_geometry.md` renders with equations, diagram, and admonitions.
  </verify>
  <done>
  Ray trace diagram generated from actual AquaCal code. Refractive geometry page covers Snell's law, ray tracing, projection model with MathJax equations, diagrams, and gotcha callouts. Cross-references to API docs work.
  </done>
</task>

<task type="auto">
  <name>Task 2: Coordinate conventions and optimizer pipeline theory pages</name>
  <files>
    docs/guide/coordinates.md
    docs/guide/optimizer.md
  </files>
  <action>
  1. Create `docs/guide/coordinates.md` (THEO-02):
     - Title: "Coordinate Conventions"
     - Brief intro: why coordinate conventions matter for calibration
     - **World Frame** section:
       - Origin at reference camera optical center
       - +X right, +Y forward, +Z down (into water)
       - Units: meters
       - Key Z-values: cameras near Z≈0, water surface at Z=water_z, targets at Z>water_z
       - Include coordinate frames diagram from `_diagrams/coordinate_frames.py`
     - **Camera Frame (OpenCV)** section:
       - +X right, +Y down, +Z forward (optical axis)
       - Brief explanation of OpenCV convention for readers unfamiliar
       - Pixel coordinates: (u,v) = (column, row), origin top-left
     - **Extrinsics Convention** section:
       - Formula: p_cam = R @ p_world + t
       - What R and t represent physically
       - Reference camera has R=I, t=0
     - **Interface Normal** section:
       - Normal vector [0, 0, -1] points from water toward air (upward)
       - Why this convention (consistent with "outward" from denser medium)
     - **Gotcha admonitions**:
       - Don't confuse world Z-down with camera Y-down — they're different frames
       - `interface_distance` naming is misleading — see refractive geometry page
       - OpenCV Y-down means image row 0 is at the top
     - "See Also" links to refractive_geometry.md and optimizer.md

  2. Create `docs/guide/optimizer.md` (THEO-03):
     - Title: "Optimizer Pipeline"
     - Brief intro: four-stage calibration from raw detections to refined result
     - **Pipeline Overview** section:
       - ASCII flow diagram of 4 stages (user decision: simple flow diagrams use ASCII)
       ```
       Stage 1        Stage 2         Stage 3              Stage 4
       In-air    →    Extrinsic   →   Joint Refractive  →  Intrinsic
       Intrinsics     Init (BFS)      Bundle Adjustment    Refinement
       ```
       - What each stage inputs and outputs
     - **Stage 1: Intrinsic Calibration** section:
       - Standard OpenCV calibration per camera
       - In-air images (no refraction)
       - Outputs: camera matrix K, distortion coefficients
     - **Stage 2: Extrinsic Initialization** section:
       - BFS pose graph from shared board observations
       - How pairwise transforms chain to global frame
       - Why initialization matters for nonlinear optimization
     - **Stage 3: Joint Refractive Bundle Adjustment** section:
       - What's optimized jointly: camera extrinsics, global water_z, board poses
       - Parameter vector layout (brief: 6 params/camera + 1 water_z + 6 params/board)
       - Cost function: refractive reprojection error
       - Loss function: soft_l1 for robustness to outliers
       - Reference to sparse Jacobian strategy (next section)
     - **Stage 4: Intrinsic Refinement** section:
       - Optional stage adding fx, fy, cx, cy per camera
       - When to use vs. skip
     - **Sparse Jacobian Strategy** section:
       - The problem: `jac_sparsity` forces LSMR solver which can diverge
       - The solution: custom Jacobian callable with sparse finite differences but dense output
       - Column grouping reduces evaluations (from knowledge-base: 13 groups instead of 33 columns)
       - `dense_threshold` parameter for automatic fallback on large problems
       - Reference to {func} or {mod} for `_optim_common`
     - **Gotcha admonitions**:
       - water_z is unobservable when n_air == n_water (non-refractive mode)
       - water_z is a global parameter, not per-camera
     - "See Also" links to refractive_geometry.md and coordinates.md
  </action>
  <verify>
  `python -m sphinx docs docs/_build -b html -W` builds without errors. Verify all three theory pages render correctly with equations, diagrams, admonitions, and cross-references.
  </verify>
  <done>
  Coordinates page covers world frame, camera frame, extrinsics convention, and interface normal with diagram. Optimizer page covers four-stage pipeline with ASCII flow, parameter layout, sparse Jacobian strategy, and loss functions. All three theory pages are self-contained with gotcha callouts and cross-links.
  </done>
</task>

</tasks>

<verification>
1. `python docs/guide/_diagrams/generate_all.py` generates diagrams without errors
2. `python -m sphinx docs docs/_build -b html` builds without errors
3. Refractive geometry page has: Snell's law equation, ray trace diagram, projection model, 2+ gotcha admonitions
4. Coordinates page has: world frame table, camera frame table, coordinate diagram, extrinsics formula
5. Optimizer page has: ASCII pipeline flow, all 4 stages documented, sparse Jacobian section, parameter layout
6. Cross-references between theory pages work (clickable links)
7. {func} references to API docs resolve (or degrade gracefully if API pages not yet built)
</verification>

<success_criteria>
All three theory pages (THEO-01, THEO-02, THEO-03) are complete with MathJax equations, matplotlib diagrams from actual code, gotcha admonitions, and cross-references. Sphinx builds cleanly.
</success_criteria>

<output>
After completion, create `.planning/phases/05-documentation-site/05-02-SUMMARY.md`
</output>
