---
phase: 05-documentation-site
plan: 04
type: gap_closure
wave: 3
depends_on: ["05-02"]
files_modified:
  - docs/guide/_diagrams/ray_trace.py
autonomous: true

must_haves:
  truths:
    - "Ray trace diagram imports actual AquaCal projection functions for accuracy"
  artifacts:
    - path: "docs/guide/_diagrams/ray_trace.py"
      provides: "Matplotlib diagram using actual aquacal.core.refractive_geometry functions"
      contains: "from aquacal"
---

<objective>
Replace the hand-rolled Newton-Raphson Snell's law logic in ray_trace.py with imports from aquacal.core.refractive_geometry, so the diagram uses actual library functions to compute the refracted ray path.

Purpose: Close the one remaining verification gap (19/20 -> 20/20). The diagram should auto-update if the projection model ever changes.
Output: ray_trace.py imports snells_law_3d from aquacal and uses it to compute the refracted direction at the interface point.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@docs/guide/_diagrams/ray_trace.py
@src/aquacal/core/refractive_geometry.py
@.planning/phases/05-documentation-site/05-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace hand-rolled Snell's law with aquacal imports</name>
  <files>
    docs/guide/_diagrams/ray_trace.py
  </files>
  <action>
  Edit `docs/guide/_diagrams/ray_trace.py` to:

  1. Add import after the sys.path setup:
     ```python
     from aquacal.core.refractive_geometry import snells_law_3d
     ```

  2. Replace lines 28-59 (the hand-rolled Newton-Raphson block) with logic that uses `snells_law_3d`:
     - Compute the incident ray direction from camera C to the interface point guess, then use `snells_law_3d` to get the refracted direction.
     - Approach: Use a simple 1D root-finding loop (or direct geometric calculation) to find the interface crossing X-coordinate `r_p` such that a ray from C through P=(C[0]+r_p, 0, water_z), refracted via `snells_law_3d`, hits target Q.
     - Specifically:
       a. Keep the initial guess: `r_p = r_q * h_c / (h_c + h_q)`
       b. Iterate (5 Newton steps): compute incident direction `d_inc = P - C` (normalized), call `snells_law_3d(d_inc, normal, n_air/n_water)` to get refracted direction, then check if the refracted ray from P reaches Q's X-coordinate at Q's Z-depth. Adjust r_p based on the residual.
     - The key change: the Snell's law computation uses the actual library function instead of inline math.
     - Interface normal is `np.array([0.0, 0.0, -1.0])` (points up, from water toward air), matching the project convention.

  3. Keep all plotting code (lines 60+) unchanged. The variables `P`, `theta_air`, `theta_water` must still be computed for the diagram annotations. Compute angles from the incident and refracted direction vectors returned by `snells_law_3d`.

  4. Run Black formatter on the file.
  </action>
  <verify>
  1. `grep "from aquacal" docs/guide/_diagrams/ray_trace.py` returns a match
  2. `grep "snells_law_3d" docs/guide/_diagrams/ray_trace.py` returns a match
  3. The file does NOT contain the old hand-rolled Newton-Raphson Snell equation (`n_air * sin_air - n_water * sin_water`)
  4. `python docs/guide/_diagrams/ray_trace.py` (or the generate_all script) runs without error and produces the diagram
  5. `python -m pytest tests/ -m "not slow"` passes (no regressions)
  </verify>
  <done>
  ray_trace.py imports `snells_law_3d` from `aquacal.core.refractive_geometry` and uses it to compute the refracted ray direction at the water surface interface. No hand-rolled Snell's law logic remains. Diagram output is visually identical.
  </done>
</task>

</tasks>
/clear
<verification>
1. `docs/guide/_diagrams/ray_trace.py` contains `from aquacal.core.refractive_geometry import snells_law_3d`
2. No hand-rolled Snell's law equation remains in the file (no `n_air * sin_air` pattern)
3. Diagram generation succeeds: `python -c "from pathlib import Path; import sys; sys.path.insert(0, 'src'); exec(open('docs/guide/_diagrams/ray_trace.py').read()); generate(Path('docs/_static/diagrams'))"` produces ray_trace.png
4. `python -m pytest tests/ -m "not slow"` passes
</verification>

<success_criteria>
The ray_trace.py diagram script imports and uses actual aquacal.core.refractive_geometry functions instead of reimplementing Snell's law, closing the last verification gap for Phase 5.
</success_criteria>

<output>
After completion, create `.planning/phases/05-documentation-site/05-04-SUMMARY.md`
</output>
