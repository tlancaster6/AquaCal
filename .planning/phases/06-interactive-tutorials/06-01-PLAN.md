---
phase: 06-interactive-tutorials
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/aquacal/io/frameset.py
  - src/aquacal/io/images.py
  - src/aquacal/io/detection.py
  - src/aquacal/io/__init__.py
  - tests/unit/test_images.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "Config paths pointing to image directories are auto-detected and loaded as ImageSet"
    - "Config paths pointing to video files continue to work as VideoSet"
    - "ImageSet loads JPEG/PNG files in natural sort order"
    - "ImageSet raises ValueError when camera directories have different image counts"
    - "detect_all_frames accepts both VideoSet and ImageSet via FrameSet protocol"
  artifacts:
    - path: "src/aquacal/io/frameset.py"
      provides: "FrameSet Protocol defining common interface"
      contains: "class FrameSet"
    - path: "src/aquacal/io/images.py"
      provides: "ImageSet class for loading image directories"
      contains: "class ImageSet"
    - path: "tests/unit/test_images.py"
      provides: "Unit tests for ImageSet and auto-detection"
  key_links:
    - from: "src/aquacal/io/detection.py"
      to: "src/aquacal/io/images.py"
      via: "auto-detection in _create_frame_source"
      pattern: "_create_frame_source"
    - from: "src/aquacal/io/images.py"
      to: "natsort"
      via: "natsorted for filename ordering"
      pattern: "natsorted"
---

<objective>
Implement FrameSet protocol abstraction and ImageSet class for loading image directories, then integrate into detection pipeline with auto-detection of input type.

Purpose: Enable the pipeline to accept image directories (JPEG/PNG) alongside video files, which is needed for the `load_example('real-rig')` dataset flow and general user convenience.
Output: `frameset.py` (Protocol), `images.py` (ImageSet), modified `detection.py`, unit tests.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/aquacal/io/video.py
@src/aquacal/io/detection.py
@src/aquacal/io/__init__.py
</context>

<feature>
  <name>FrameSet Protocol + ImageSet + Auto-Detection</name>
  <files>
    src/aquacal/io/frameset.py
    src/aquacal/io/images.py
    src/aquacal/io/detection.py
    src/aquacal/io/__init__.py
    tests/unit/test_images.py
    pyproject.toml
  </files>
  <behavior>
    ImageSet mirrors VideoSet's public API (camera_names, frame_count, iterate_frames, context manager).

    Cases:
    - ImageSet with 2 camera dirs, each with 5 JPEG files -> frame_count=5, iterate_frames yields 5 frames
    - ImageSet with dirs having different counts -> raises ValueError
    - ImageSet with empty dir -> raises ValueError
    - ImageSet with mixed jpg/png -> loads all, naturally sorted by filename
    - ImageSet natural sort: [img_1.jpg, img_2.jpg, img_10.jpg] not [img_1.jpg, img_10.jpg, img_2.jpg]
    - _create_frame_source(dict of dirs) -> returns ImageSet
    - _create_frame_source(dict of files) -> returns VideoSet
    - _create_frame_source(mixed dirs and files) -> raises ValueError
    - detect_all_frames(dict_of_dirs, board) -> uses ImageSet internally
    - No subsampling for ImageSet (step parameter ignored or always 1 per user decision: "No subsampling for image directories -- assumed pre-curated")

    FrameSet Protocol: runtime_checkable Protocol with camera_names, frame_count, iterate_frames, __enter__, __exit__.

    Add natsort>=8.4.0 to project dependencies (main, not optional -- needed at runtime).
  </behavior>
  <implementation>
    1. Add `natsort>=8.4.0` to pyproject.toml `[project.dependencies]`

    2. Create `src/aquacal/io/frameset.py`:
       - `FrameSet` as `typing.Protocol` with `@runtime_checkable`
       - Properties: `camera_names -> list[str]`, `frame_count -> int`
       - Methods: `iterate_frames(start, stop, step) -> Iterator[tuple[int, dict[str, NDArray | None]]]`
       - Context manager: `__enter__`, `__exit__`

    3. Create `src/aquacal/io/images.py`:
       - `ImageSet` class mirroring VideoSet API
       - `__init__(image_dirs: dict[str, str])`: validate dirs exist, collect JPEG/PNG with pathlib glob (*.jpg, *.jpeg, *.png, case-insensitive), natsort by filename, validate all dirs have same count (strict: error, not min)
       - `camera_names`: sorted dict keys
       - `frame_count`: count from first camera (all validated equal)
       - `iterate_frames(start, stop, step)`: yield (idx, {cam: cv2.imread(path)}) -- step parameter works for consistency but users told images are pre-curated
       - `get_frame(frame_idx)`: random access by index
       - Context manager: no-op (no resources to manage, unlike VideoCapture)
       - `open()` / `close()` / `is_open` for API compatibility

    4. Modify `src/aquacal/io/detection.py`:
       - Add `_create_frame_source(paths: dict[str, str]) -> FrameSet` function
       - Auto-detect: check first path with `Path.is_dir()` vs `Path.is_file()`
       - Validate all paths are same type (all dirs or all files)
       - Update `detect_all_frames` to accept `dict[str, str] | VideoSet | ImageSet` (duck-typed via FrameSet)
       - When dict passed, use `_create_frame_source` instead of always creating VideoSet

    5. Update `src/aquacal/io/__init__.py`:
       - Add `FrameSet`, `ImageSet` to imports and `__all__`

    6. Tests (RED first, then GREEN):
       - Test ImageSet with temp directory of generated images (use cv2.imwrite to create test JPEGs)
       - Test natural sort ordering
       - Test frame count mismatch raises ValueError
       - Test empty directory raises ValueError
       - Test _create_frame_source auto-detection (mock dirs and files)
       - Test detect_all_frames still works with dict of video paths (backward compat)
  </implementation>
</feature>

<verification>
```bash
python -m pytest tests/unit/test_images.py -v
python -m pytest tests/unit/test_detection.py -v
python -m pytest tests/ -m "not slow" --timeout=120
```
</verification>

<success_criteria>
- ImageSet loads JPEG/PNG images from directories with natural sort ordering
- ImageSet raises ValueError on mismatched frame counts across cameras
- _create_frame_source auto-detects directory vs file and creates ImageSet vs VideoSet
- detect_all_frames works with dict of image directories (ImageSet) and dict of video files (VideoSet)
- All existing tests pass (no regressions)
- natsort added to pyproject.toml dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/06-interactive-tutorials/06-01-SUMMARY.md`
</output>
